<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistema de Consulta Judicial</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

    <!-- Tailwind (CDN build for quick styling + forms/typography plugins) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#10A37F",
                        "background-light": "#F9FAFB",
                        "background-dark": "#202123",
                        "panel-light": "#FFFFFF",
                        "panel-dark": "#2C2D31",
                        "text-light": "#111827",
                        "text-dark": "#FFFFFF",
                        "secondary-text-light": "#6B7280",
                        "secondary-text-dark": "#A1A1A1",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: '0.5rem',
                    },
                },
            },
        };
    </script>

    <!-- Local (fallback) styles to ensure base dark bg while other CSS loads -->
    <link rel="stylesheet" href="/static/styles.css?v=2">
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        /* Truncate cells with hover-tooltips for long values */
        .truncate-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        .truncate-cell:hover .full-text {
            display: block;
        }
        .full-text {
            display: none;
            position: absolute;
            background-color: #374151;
            color: #F9FAFB;
            padding: 8px;
            border-radius: 6px;
            z-index: 50;
            top: 100%;
            left: 0;
            white-space: normal;
            width: max-content;
            max-width: 520px;
            box-shadow: 0 6px 18px rgba(2,6,23,0.7);
        }

        /* Small helper to visually hide table when empty */
        .table-empty { padding: 28px; color: var(--secondary-text-dark); }

        /* Debug panel for showing backend responses */
        #debug-panel {
            margin-top: 18px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.02);
            color: #cbd5e1;
            font-size: 13px;
            max-height: 220px;
            overflow: auto;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark font-sans transition-colors duration-300">

<!-- LOGIN SCREEN (visible by default) -->
<div class="min-h-screen flex flex-col items-center justify-center p-4" id="login-screen">
    <div class="w-full max-w-md">
        <h1 class="text-3xl font-bold text-center mb-2 text-text-light dark:text-text-dark">Sistema de Consulta Judicial</h1>
        <p class="text-center text-secondary-text-light dark:text-secondary-text-dark mb-8">Bienvenido de nuevo</p>

        <div class="bg-panel-light dark:bg-panel-dark p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-6 text-text-light dark:text-text-dark">Iniciar Sesión</h2>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-2" for="login-email">Email</label>
                    <input id="login-email" name="email" type="email" class="w-full px-4 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary transition duration-200" required />
                </div>

                <div>
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-2" for="login-password">Contraseña</label>
                    <input id="login-password" name="password" type="password" class="w-full px-4 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary transition duration-200" required />
                </div>

                <button type="submit" class="w-full bg-primary text-white font-semibold py-2 px-4 rounded-md hover:bg-opacity-90 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-lg">
                    Iniciar Sesión
                </button>
            </form>

            <p class="text-center text-sm text-secondary-text-light dark:text-secondary-text-dark mt-6">
                ¿No tienes cuenta? <a class="text-primary hover:underline" href="#" onclick="showRegister()">Regístrate</a>
            </p>
        </div>
    </div>
</div>

<!-- APP SCREEN (hidden until login) -->
<div class="hidden min-h-screen" id="app-screen">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-20 lg:w-64 bg-panel-light dark:bg-panel-dark p-4 flex flex-col transition-all duration-300 min-h-screen">
            <div class="flex items-center justify-center lg:justify-start mb-10">
                <span class="material-icons text-primary text-3xl">gavel</span>
                <span class="ml-3 text-xl font-bold text-text-light dark:text-text-dark hidden lg:inline">Consulta</span>
            </div>

            <nav class="flex-grow">
                <ul>
                    <li class="mb-2">
                        <a id="tab-query" class="flex items-center p-3 rounded-lg text-secondary-text-light dark:text-secondary-text-dark hover:bg-background-light dark:hover:bg-background-dark hover:text-primary transition-colors duration-200 cursor-pointer">
                            <span class="material-icons">search</span>
                            <span class="ml-4 font-medium hidden lg:inline">Consultar Procesos</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a id="tab-saved" class="flex items-center p-3 rounded-lg text-secondary-text-light dark:text-secondary-text-dark hover:bg-background-light dark:hover:bg-background-dark hover:text-primary transition-colors duration-200 cursor-pointer">
                            <span class="material-icons">bookmark_border</span>
                            <span class="ml-4 font-medium hidden lg:inline">Procesos Guardados</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a id="tab-logs" class="flex items-center p-3 rounded-lg text-secondary-text-light dark:text-secondary-text-dark hover:bg-background-light dark:hover:bg-background-dark hover:text-primary transition-colors duration-200 cursor-pointer">
                            <span class="material-icons">bug_report</span>
                            <span class="ml-4 font-medium hidden lg:inline">Logs de Debug</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <div class="flex items-center p-2">
                    <div id="avatar" class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                        JR
                    </div>
                    <div class="ml-3 hidden lg:inline">
                        <p id="user-email" class="text-sm font-medium text-text-light dark:text-text-dark">user@example.com</p>
                        <button id="logout-btn" class="text-xs text-secondary-text-light dark:text-secondary-text-dark hover:text-primary mt-1">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="flex-1 p-6 lg:p-10 bg-background-light dark:bg-background-dark min-h-screen">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-text-light dark:text-text-dark">Consulta de Procesos Judiciales</h1>
                <p class="text-lg text-secondary-text-light dark:text-secondary-text-dark mt-2">Ingresa los números de radicación para iniciar la consulta.</p>
            </header>

            <div class="bg-panel-light dark:bg-panel-dark p-8 rounded-lg shadow-md">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-2" for="process-numbers">Ingresa hasta 10 números de radicación separados por comas:</label>
                    <textarea id="batch-numbers" class="w-full p-4 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary transition duration-200" placeholder="Ej: 11001418902420250012, ..." rows="4"></textarea>
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="btn-batch-query" class="w-full sm:w-auto bg-primary text-white font-semibold py-3 px-6 rounded-md hover:bg-opacity-90 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-lg flex items-center justify-center">
                        <span class="material-icons mr-2">search</span>
                        Consultar Procesos
                    </button>

                    <button id="btn-api-test" class="w-full sm:w-auto bg-transparent border border-primary text-primary font-semibold py-3 px-6 rounded-md hover:bg-primary hover:text-white transition-colors duration-200 flex items-center justify-center">
                        <span class="material-icons mr-2">api</span>
                        Probar Conexión API
                    </button>
                </div>

                <!-- Progress indicator -->
                <div id="query-progress" class="mt-4 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <div id="progress-text" class="text-sm text-secondary-text-light dark:text-secondary-text-dark">0 de 0 procesos consultados</div>
                        <div id="progress-status" class="text-sm text-secondary-text-light dark:text-secondary-text-dark"></div>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div id="progress-bar" class="h-2 rounded-full bg-primary" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="mt-12">
                <h2 class="text-2xl font-semibold mb-6 text-text-light dark:text-text-dark">Resultados</h2>
                <div id="query-result">
                    <!-- Table and controls will be rendered here by JavaScript -->
                    <div class="table-loading">Cargando resultados...</div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Scripts: reuse existing logic but adapt to new IDs and screen toggles -->
<script>
    // Keep auth token and current user
    let authToken = localStorage.getItem('authToken');
    let currentUser = null;

    const loginScreen = document.getElementById('login-screen');
    const appScreen = document.getElementById('app-screen');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const userEmailSpan = document.getElementById('user-email');

    // Buttons
    const btnBatchQuery = document.getElementById('btn-batch-query');
    const btnApiTest = document.getElementById('btn-api-test');

    // Tabs
    document.getElementById('tab-query').addEventListener('click', () => showTab('query'));
    document.getElementById('tab-saved').addEventListener('click', () => showTab('saved'));
    document.getElementById('tab-logs').addEventListener('click', () => showTab('logs'));

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        if (authToken) {
            // verify token quickly (non-blocking)
            showApp();
            loadUserInfo();
        } else {
            showAuth();
        }
    });

    // Login form submit
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await login();
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
        logout();
    });

    // Wire main action buttons
    btnBatchQuery.addEventListener('click', () => batchQuery());
    btnApiTest.addEventListener('click', () => testAPIConnection());

    // Show/hide helpers
    function showAuth() {
        loginScreen.classList.remove('hidden');
        appScreen.classList.add('hidden');
    }

    function showApp() {
        loginScreen.classList.add('hidden');
        appScreen.classList.remove('hidden');
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if (!email || !password) {
            alert('Por favor completa todos los campos');
            return;
        }

        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (response.ok) {
                authToken = data.access_token;
                localStorage.setItem('authToken', authToken);
                showApp();
                await loadUserInfo();
            } else {
                alert(data.detail || 'Error en el inicio de sesión');
            }
        } catch (error) {
            alert('Error de conexión');
        }
    }

    async function register() {
        // simple register flow to mirror previous behavior
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if (!email || !password) {
            alert('Por favor completa todos los campos');
            return;
        }

        try {
            const response = await fetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (response.ok) {
                authToken = data.access_token;
                localStorage.setItem('authToken', authToken);
                showApp();
                await loadUserInfo();
            } else {
                alert(data.detail || 'Error en el registro');
            }
        } catch (err) {
            alert('Error de conexión');
        }
    }

    function showRegister(){
        // open register: reuse login inputs but call register instead
        if (confirm('Registrar con los datos ingresados en el formulario?')) {
            register();
        }
    }

    function logout() {
        authToken = null;
        localStorage.removeItem('authToken');
        currentUser = null;
        userEmailSpan.textContent = '';
        showAuth();
    }

    async function loadUserInfo() {
        if (!authToken) return;
        try {
            const response = await fetch('/auth/me', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (response.ok) {
                currentUser = await response.json();
                userEmailSpan.textContent = ` ${currentUser.email}`;
                // set avatar initials
                const initials = (currentUser.email || 'U').split('@')[0].slice(0,2).toUpperCase();
                document.getElementById('avatar').textContent = initials;
            } else {
                logout();
            }
        } catch (error) {
            console.error('Error loading user info:', error);
        }
    }

    // Tabs handling
    function showTab(tabName){
        // simple client-only switching for demo; could trigger loads
        document.querySelectorAll('#app-screen nav ul li a').forEach(a => a.classList.remove('bg-background-light','dark:bg-background-dark'));
        if(tabName === 'query'){
            // ensure query is visible (we only have one main view so nothing to toggle)
        } else if(tabName === 'saved'){
            loadSavedProcesses();
        } else if(tabName === 'logs'){
            loadLogs();
        }
    }

    // Batch query (tries public batch endpoint first, falls back to per-radicado calls)
    async function batchQuery() {
        const raw = document.getElementById('batch-numbers').value.trim();
        if (!raw) {
            alert('Por favor ingresa al menos un número de radicación');
            return;
        }
        const numbers = raw.split(',').map(n => n.trim()).filter(n => n);
        if (numbers.length > 10) {
            alert('Máximo 10 procesos por consulta');
            return;
        }
    
        // Validate and normalize
        const validNumbers = [];
        for (const num of numbers) {
            if (num.length !== 23 || !/^\d+$/.test(num)) {
                console.warn(`Formato inesperado para: ${num}`);
                validNumbers.push(num); // include but will likely error server-side
            } else {
                validNumbers.push(num);
            }
        }
    
        if (validNumbers.length === 0) {
            alert('No hay números válidos para consultar.');
            return;
        }
    
        // Show progress UI
        const progressContainer = document.getElementById('query-progress');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const progressStatus = document.getElementById('progress-status');
        progressContainer.classList.remove('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = `0 de ${validNumbers.length} procesos consultados`;
        progressStatus.textContent = 'Iniciando consultas...';
    
        // Ensure debug panel is visible and cleared
        const debugPanel = document.getElementById('debug-panel');
        if (debugPanel) {
            debugPanel.classList.remove('hidden');
            debugPanel.innerHTML = '<h3 class="text-sm font-medium mb-2 text-secondary-text-light dark:text-secondary-text-dark">Debug responses (most recent arriba)</h3>';
        }
    
        // Call the batch endpoint /api/procesos?q=... (no fallback to single-query)
        try {
            progressStatus.textContent = 'Consultando endpoint batch /api/procesos...';
            const q = validNumbers.join(',');
            const resp = await fetch(`/api/procesos?q=${encodeURIComponent(q)}`, {
                method: 'GET',
                headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
            });
            const data = await resp.json();
    
            // Append raw batch response to debug panel
            if (debugPanel) {
                const entry = document.createElement('div');
                entry.style.whiteSpace = 'pre-wrap';
                entry.style.fontSize = '12px';
                entry.style.padding = '8px';
                entry.style.marginBottom = '8px';
                entry.style.background = resp.ok ? 'rgba(255,255,255,0.02)' : 'rgba(255,0,0,0.03)';
                entry.style.borderRadius = '6px';
                entry.style.color = '#cbd5e1';
                entry.innerText = `[${new Date().toLocaleTimeString()}] BATCH -> ${JSON.stringify(data, null, 2)}`;
                debugPanel.insertBefore(entry, debugPanel.children[1] || null);
            }
    
            if (!resp.ok) {
                // Server returned an error
                console.error('Batch endpoint returned HTTP error', resp.status, data);
                progressStatus.textContent = `Error batch: ${resp.status}`;
                progressBar.style.width = '0%';
                // Show error to user and stop
                const container = document.getElementById('query-result');
                container.innerHTML = `<div class="table-error">Error al consultar el endpoint batch: ${data.detail || resp.status}</div>`;
                setTimeout(() => progressContainer.classList.add('hidden'), 1200);
                return;
            }
    
            if (!data || !Array.isArray(data.results)) {
                console.error('Batch endpoint returned unexpected payload', data);
                const container = document.getElementById('query-result');
                container.innerHTML = `<div class="table-error">Respuesta inesperada del servidor.</div>`;
                progressStatus.textContent = 'Error';
                setTimeout(() => progressContainer.classList.add('hidden'), 1200);
                return;
            }
    
            // Success - render results (the backend returns canonical keys)
            displayBatchResults(data.results);
            progressBar.style.width = '100%';
            progressText.textContent = `${data.results.length} de ${validNumbers.length} procesos consultados`;
            progressStatus.textContent = 'Completado (batch)';
            setTimeout(() => progressContainer.classList.add('hidden'), 1200);
            return;
    
        } catch (err) {
            console.error('Error calling /api/procesos:', err);
            if (debugPanel) {
                const entry = document.createElement('div');
                entry.style.whiteSpace = 'pre-wrap';
                entry.style.fontSize = '12px';
                entry.style.padding = '8px';
                entry.style.marginBottom = '8px';
                entry.style.background = 'rgba(255,0,0,0.03)';
                entry.style.borderRadius = '6px';
                entry.style.color = '#f8d7da';
                entry.innerText = `[${new Date().toLocaleTimeString()}] BATCH_FAIL -> EXCEPTION: ${String(err)}`;
                debugPanel.insertBefore(entry, debugPanel.children[1] || null);
            }
    
            const container = document.getElementById('query-result');
            container.innerHTML = `<div class="table-error">No se pudo conectar al endpoint batch. Intenta más tarde.</div>`;
            progressStatus.textContent = 'Error';
            progressBar.style.width = '0%';
            setTimeout(() => progressContainer.classList.add('hidden'), 1200);
            return;
        }
    }

    // Store last results for sorting / re-render
    let lastResults = [];
    let allResults = [];
    let filteredResults = [];
    let currentPage = 1;
    let pageSize = 25;

    function renderResultsTable(results) {
        const container = document.getElementById('query-result');
        if (!results || results.length === 0) {
            container.innerHTML = '<div class="table-empty">No hay resultados.</div>';
            return;
        }

        // Controls for filter and pagination (above table)
        const controlsHtml = `
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                <div class="flex items-center gap-4">
                    <label for="table-filter" class="text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark">Filtrar:</label>
                    <input id="table-filter" type="text" placeholder="Buscar en resultados..." class="px-3 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-primary focus:border-primary" oninput="filterTable()">
                </div>
                <div class="flex items-center gap-4">
                    <label for="table-page-size" class="text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark">Mostrar:</label>
                    <select id="table-page-size" class="px-3 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-primary focus:border-primary" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
        `;

        // Table with correct columns
        const tableHtml = `
            <div class="table-container">
                <table id="results-table" role="table" aria-label="Resultados de consulta de procesos judiciales">
                    <thead>
                        <tr>
                            <th scope="col" onclick="sortTable('radicado')" style="cursor:pointer;" aria-sort="none">Radicado</th>
                            <th scope="col" onclick="sortTable('demandante')" style="cursor:pointer;" aria-sort="none">Demandante</th>
                            <th scope="col" onclick="sortTable('demandado')" style="cursor:pointer;" aria-sort="none">Demandado</th>
                            <th scope="col" onclick="sortTable('juzgado')" style="cursor:pointer;" aria-sort="none">Juzgado</th>
                            <th scope="col" onclick="sortTable('clase')" style="cursor:pointer;" aria-sort="none">Clase</th>
                            <th scope="col" onclick="sortTable('subclase')" style="cursor:pointer;" aria-sort="none">Subclase</th>
                            <th scope="col" onclick="sortTable('ubicacion')" style="cursor:pointer;" aria-sort="none">Ubicación</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                    </tbody>
                </table>
                <div id="pagination-controls" class="flex justify-center items-center gap-2 mt-4"></div>
            </div>
        `;

        container.innerHTML = controlsHtml + tableHtml;

        // Initialize pagination and filtering
        allResults = [...results];
        filteredResults = [...results];
        currentPage = 1;
        pageSize = parseInt(document.getElementById('table-page-size').value) || 25;
        renderTablePage();
    }

    // Filter table based on input
    function filterTable() {
        const filterValue = document.getElementById('table-filter').value.toLowerCase();
        filteredResults = allResults.filter(proc =>
            (proc.radicado || '').toLowerCase().includes(filterValue) ||
            (proc.demandante || '').toLowerCase().includes(filterValue) ||
            (proc.demandado || '').toLowerCase().includes(filterValue) ||
            (proc.juzgado || '').toLowerCase().includes(filterValue) ||
            (proc.clase || '').toLowerCase().includes(filterValue) ||
            (proc.subclase || '').toLowerCase().includes(filterValue) ||
            (proc.ubicacion || '').toLowerCase().includes(filterValue)
        );
        currentPage = 1;
        renderTablePage();
    }

    // Change page size
    function changePageSize() {
        pageSize = parseInt(document.getElementById('table-page-size').value);
        currentPage = 1;
        renderTablePage();
    }

    // Render current page of results
    function renderTablePage() {
        const tbody = document.getElementById('results-tbody');
        tbody.innerHTML = '';

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageResults = filteredResults.slice(startIndex, endIndex);

        pageResults.forEach(proc => {
            const demandante = proc.demandante || 'N/A';
            const demandado = proc.demandado || 'N/A';
            const juzgado = proc.juzgado || 'Información no disponible.';
            const clase = proc.clase || 'N/A';
            const subclase = proc.subclase || 'N/A';
            const ubicacion = proc.ubicacion || 'N/A';
            const fecha = formateaFecha(proc.fechaUltimaActuacion); // Use helper for formatting

            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700 hover:bg-background-light dark:hover:bg-background-dark transition-colors duration-200';

            // Build row with tooltip on radicado
            const encodedProc = encodeURIComponent(JSON.stringify(proc));
            row.innerHTML = `
                <th class="px-6 py-4 font-medium text-text-light dark:text-text-dark whitespace-nowrap" scope="row" title="idProceso: ${proc.idProceso || 'N/A'}">${proc.radicado}</th>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(demandante)}</span><span class="full-text">${escapeHtml(demandante)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(demandado)}</span><span class="full-text">${escapeHtml(demandado)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(juzgado)}</span><span class="full-text">${escapeHtml(juzgado)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(clase)}</span><span class="full-text">${escapeHtml(clase)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(subclase)}</span><span class="full-text">${escapeHtml(subclase)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(ubicacion)}</span><span class="full-text">${escapeHtml(ubicacion)}</span></td>
                <td class="px-6 py-4">${escapeHtml(fecha)}</td>
                <td class="px-6 py-4 text-right">
                    ${proc.error ? `<span class="text-red-500 text-xs">${proc.error}</span>` : `
                    <button class="font-medium text-primary hover:underline flex items-center gap-1" onclick="saveProcess('${proc.radicado}', '${encodedProc}')">
                        <span class="material-icons text-sm">bookmark_add</span>
                        Guardar
                    </button>
                    `}
                </td>
            `;
            tbody.appendChild(row);
        });

        // Add pagination controls if needed
        const totalPages = Math.ceil(filteredResults.length / pageSize);
        const paginationControls = document.getElementById('pagination-controls');

        if (totalPages > 1) {
            const paginationHtml = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="px-3 py-1 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded text-sm">Anterior</button>
                <span class="text-sm text-secondary-text-light dark:text-secondary-text-dark">Página ${currentPage} de ${totalPages}</span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} class="px-3 py-1 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded text-sm">Siguiente</button>
            `;
            paginationControls.innerHTML = paginationHtml;
        } else {
            paginationControls.innerHTML = '';
        }
    }

    // Change page
    function changePage(page) {
        const totalPages = Math.ceil(filteredResults.length / pageSize);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderTablePage();
        }
    }

    function displayBatchResults(results){
        // Normalize results to the expected structure and sanitize values to avoid "Not Found" / "N/A" leaking
        const normalize = (v) => {
            if (v === null || v === undefined) return '';
            if (typeof v === 'string') {
                const t = v.trim();
                if (!t) return '';
                // Normalize common placeholders
                if (t.toLowerCase() === 'not found' || t === 'N/A') return '';
                return t;
            }
            return String(v);
        };
    
        allResults = results.map(r => {
            return {
                radicado: r.radicado || r.numero || '',
                idProceso: r.idProceso || r.id_proceso || '',
                demandante: normalize(r.demandante),
                demandado: normalize(r.demandado),
                juzgado: normalize(r.juzgado || r.despacho),
                clase: normalize(r.clase || r.clase_proceso),
                subclase: normalize(r.subclase || r.subclase_proceso),
                ubicacion: normalize(r.ubicacion),
                // Keep date as ISO string or null (render layer will show "N/A" safely)
                fechaUltimaActuacion: r.fechaUltimaActuacion || r.fecha_ultima_actuacion || null,
                _raw: r._raw || null // Keep raw data for debug if needed
            };
        });
        renderResultsTable(allResults);
    }

    // Simple sort implementation (toggles asc/desc)
    let currentSort = { col: null, dir: 1 }; // 1 asc, -1 desc
    function sortTable(col){
        if (!col) return;
        
        // Update aria-sort attributes
        document.querySelectorAll('#results-table th').forEach(th => {
            if (th.onclick && th.onclick.toString().includes(`sortTable('${col}')`)) {
                th.setAttribute('aria-sort', currentSort.col === col && currentSort.dir === 1 ? 'ascending' : 'descending');
            } else {
                th.setAttribute('aria-sort', 'none');
            }
        });

        if (currentSort.col === col) currentSort.dir = -currentSort.dir;
        else { currentSort.col = col; currentSort.dir = 1; }

        allResults.sort((a,b) => {
            const va = (a[col] || '').toString().toLowerCase();
            const vb = (b[col] || '').toString().toLowerCase();
            if (va < vb) return -1 * currentSort.dir;
            if (va > vb) return 1 * currentSort.dir;
            return 0;
        });
        filteredResults = [...allResults];
        currentPage = 1;
        renderTablePage();
    }

    // Helper to POST saved process to backend
    async function saveProcess(radicado, procString) {
        try {
            const proc = JSON.parse(decodeURIComponent(procString));
            const payload = {
                numero: proc.radicado || radicado,
                id_proceso: proc.idProceso || '',
                // Send the backend-provided fechaUltimaActuacion as-is (backend will accept ISO or null)
                fecha_ultima_actuacion: proc.fechaUltimaActuacion || null,
                despacho: proc.juzgado || '',
                departamento: '', // Not available in current API response
                demandante: proc.demandante || '',
                demandado: proc.demandado || '',
                response_json: JSON.stringify(proc._raw?.consulta || {}),
                detalle_json: JSON.stringify(proc._raw?.detalle || {}),
                tipo_proceso: proc.tipo || '', // Assuming 'tipo' from mock is 'tipo_proceso'
                clase_proceso: proc.clase || '',
                subclase_proceso: proc.subclase || '',
                recurso: '', // Not available
                ponente: '', // Not available
                ubicacion: proc.ubicacion || ''
            };

            const resp = await fetch('/processes/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(payload)
            });

            const data = await resp.json();
            if (resp.ok) {
                alert(`Proceso ${radicado} guardado (${data.action})`);
            } else {
                alert(`Error guardando proceso: ${data.detail || JSON.stringify(data)}`);
            }
        } catch (err) {
            console.error('saveProcess error:', err);
            alert('Error guardando proceso (ver consola).');
        }
    }

    // Utility to escape HTML in table cells
    function escapeHtml(text){
        if (text === null || text === undefined) return '';
        return String(text)
            .replace(/&/g, '&')
            .replace(/</g, '<')
            .replace(/>/g, '>')
            .replace(/"/g, '"')
            .replace(/'/g, '&#039;');
    }

    // Helper to format date to DD/MM/YYYY (defensive: avoids NaN/NaN/NaN)
    function formateaFecha(iso) {
        if (!iso) return 'N/A';
        // If already formatted as DD/MM/YYYY return it
        if (typeof iso === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(iso.trim())) return iso.trim();
        if (iso === 'N/A') return 'N/A';
        try {
            const d = new Date(iso);
            if (isNaN(d.getTime())) return 'N/A';
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        } catch (e) {
            console.error("Error formatting date:", iso, e);
            return 'N/A';
        }
    }

    // Helper to parse sujetosProcesales
    function parseSujetos(s) {
        if (!s) return { demandante: 'N/A', demandado: 'N/A' };
        const parts = s.split('|').map(x => x.trim());
        const ds = [], dd = [];
        for (const p of parts) {
            const lower = p.toLowerCase();
            if (lower.startsWith('demandante:')) ds.push(p.split(':')[1].trim());
            if (lower.startsWith('demandado:')) dd.push(p.split(':')[1].trim());
        }
        return {
            demandante: ds.length ? ds.join(', ') : 'N/A',
            demandado: dd.length ? dd.join(', ') : 'N/A',
        };
    }

    async function testAPIConnection(){
        try{
            const response = await fetch('/api-test');
            const data = await response.json();
            if(response.ok && data.status === 'success'){
                alert('Conexión API exitosa');
            } else {
                alert('Error al conectar con la API');
            }
        } catch(err){
            alert('Error de conexión');
        }
    }

    // Saved processes and logs (light implementations)
    async function loadSavedProcesses(){
        if(!authToken) return;
        const container = document.getElementById('query-result');
        container.innerHTML = '<div class="table-loading">Cargando procesos guardados...</div>';

        try{
            const resp = await fetch('/processes/my-processes', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const data = await resp.json();
            if(resp.ok){
                displayBatchResults(data.processes || []);
            } else {
                container.innerHTML = `<div class="table-error">Error cargando procesos guardados: ${data.detail || 'Error desconocido'}</div>`;
                console.error('Error cargando procesos guardados:', data);
            }
        } catch(err){
            container.innerHTML = `<div class="table-error">Error de conexión al cargar procesos guardados.</div>`;
            console.error('Error de conexión al cargar procesos guardados:', err);
        }
    }

    async function loadLogs(){
        if(!authToken) return;
        const container = document.getElementById('query-result');
        container.innerHTML = '<div class="table-loading">Cargando logs...</div>';

        try{
            const resp = await fetch('/logs', { headers: { 'Authorization': `Bearer ${authToken}` }});
            const data = await resp.json();
            if(resp.ok){
                if (data.logs && data.logs.length > 0) {
                    // Display logs in a pre-formatted block, not a table for now
                    container.innerHTML = `
                        <div class="bg-panel-light dark:bg-panel-dark p-6 rounded-lg shadow-md overflow-x-auto">
                            <h3 class="text-lg font-semibold mb-4 text-text-light dark:text-text-dark">Historial de Logs</h3>
                            <pre class="text-sm text-secondary-text-light dark:text-secondary-text-dark whitespace-pre-wrap">${JSON.stringify(data.logs, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="table-empty">No hay logs disponibles.</div>';
                }
            } else {
                container.innerHTML = `<div class="table-error">Error cargando logs: ${data.detail || 'Error desconocido'}</div>`;
                console.error('Error cargando logs:', data);
            }
        } catch(e){
            container.innerHTML = `<div class="table-error">Error de conexión al cargar logs.</div>`;
            console.error('Error de conexión al cargar logs:', e);
        }
    }
</script>

</body>
</html>