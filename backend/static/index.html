<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistema de Consulta Judicial</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

    <!-- Tailwind (CDN build for quick styling + forms/typography plugins) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#10A37F",
                        "background-light": "#F9FAFB",
                        "background-dark": "#202123",
                        "panel-light": "#FFFFFF",
                        "panel-dark": "#2C2D31",
                        "text-light": "#111827",
                        "text-dark": "#FFFFFF",
                        "secondary-text-light": "#6B7280",
                        "secondary-text-dark": "#A1A1A1",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: '0.5rem',
                    },
                },
            },
        };
    </script>

    <!-- Local (fallback) styles to ensure base dark bg while other CSS loads -->
    <link rel="stylesheet" href="/static/styles.css?v=2">
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        /* Truncate cells with hover-tooltips for long values */
        .truncate-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        .truncate-cell:hover .full-text {
            display: block;
        }
        .full-text {
            display: none;
            position: absolute;
            background-color: #374151;
            color: #F9FAFB;
            padding: 8px;
            border-radius: 6px;
            z-index: 50;
            top: 100%;
            left: 0;
            white-space: normal;
            width: max-content;
            max-width: 520px;
            box-shadow: 0 6px 18px rgba(2,6,23,0.7);
        }

        /* Small helper to visually hide table when empty */
        .table-empty { padding: 28px; color: var(--secondary-text-dark); }

        /* Debug panel for showing backend responses */
        #debug-panel {
            margin-top: 18px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.02);
            color: #cbd5e1;
            font-size: 13px;
            max-height: 220px;
            overflow: auto;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark font-sans transition-colors duration-300">

<!-- LOGIN SCREEN (visible by default) -->
<div class="min-h-screen flex flex-col items-center justify-center p-4" id="login-screen">
    <div class="w-full max-w-md">
        <h1 class="text-3xl font-bold text-center mb-2 text-text-light dark:text-text-dark">Sistema de Consulta Judicial</h1>
        <p class="text-center text-secondary-text-light dark:text-secondary-text-dark mb-8">Bienvenido de nuevo</p>

        <div class="bg-panel-light dark:bg-panel-dark p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-6 text-text-light dark:text-text-dark">Iniciar Sesión</h2>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-2" for="login-email">Email</label>
                    <input id="login-email" name="email" type="email" class="w-full px-4 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary transition duration-200" required />
                </div>

                <div>
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-2" for="login-password">Contraseña</label>
                    <input id="login-password" name="password" type="password" class="w-full px-4 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary transition duration-200" required />
                </div>

                <button type="submit" class="w-full bg-primary text-white font-semibold py-2 px-4 rounded-md hover:bg-opacity-90 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-lg">
                    Iniciar Sesión
                </button>
            </form>

            <p class="text-center text-sm text-secondary-text-light dark:text-secondary-text-dark mt-6">
                ¿No tienes cuenta? <a class="text-primary hover:underline" href="#" onclick="showRegister()">Regístrate</a>
            </p>
        </div>
    </div>
</div>

<!-- APP SCREEN (hidden until login) -->
<div class="hidden min-h-screen" id="app-screen">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-20 lg:w-64 bg-panel-light dark:bg-panel-dark p-4 flex flex-col transition-all duration-300 min-h-screen">
            <div class="flex items-center justify-center lg:justify-start mb-10">
                <span class="material-icons text-primary text-3xl">gavel</span>
                <span class="ml-3 text-xl font-bold text-text-light dark:text-text-dark hidden lg:inline">Consulta</span>
            </div>

            <nav class="flex-grow">
                <ul>
                    <li class="mb-2">
                        <a id="tab-query" class="flex items-center p-3 rounded-lg text-secondary-text-light dark:text-secondary-text-dark hover:bg-background-light dark:hover:bg-background-dark hover:text-primary transition-colors duration-200 cursor-pointer">
                            <span class="material-icons">search</span>
                            <span class="ml-4 font-medium hidden lg:inline">Consultar Procesos</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a id="tab-saved" class="flex items-center p-3 rounded-lg text-secondary-text-light dark:text-secondary-text-dark hover:bg-background-light dark:hover:bg-background-dark hover:text-primary transition-colors duration-200 cursor-pointer">
                            <span class="material-icons">bookmark_border</span>
                            <span class="ml-4 font-medium hidden lg:inline">Procesos Guardados</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a id="tab-logs" class="flex items-center p-3 rounded-lg text-secondary-text-light dark:text-secondary-text-dark hover:bg-background-light dark:hover:bg-background-dark hover:text-primary transition-colors duration-200 cursor-pointer">
                            <span class="material-icons">bug_report</span>
                            <span class="ml-4 font-medium hidden lg:inline">Logs de Debug</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <div class="flex items-center p-2">
                    <div id="avatar" class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                        JR
                    </div>
                    <div class="ml-3 hidden lg:inline">
                        <p id="user-email" class="text-sm font-medium text-text-light dark:text-text-dark">user@example.com</p>
                        <button id="logout-btn" class="text-xs text-secondary-text-light dark:text-secondary-text-dark hover:text-primary mt-1">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="flex-1 p-6 lg:p-10 bg-background-light dark:bg-background-dark min-h-screen">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-text-light dark:text-text-dark">Consulta de Procesos Judiciales</h1>
                <p class="text-lg text-secondary-text-light dark:text-secondary-text-dark mt-2">Ingresa los números de radicación para iniciar la consulta.</p>
            </header>

            <div class="bg-panel-light dark:bg-panel-dark p-8 rounded-lg shadow-md">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-2" for="process-numbers">Ingresa hasta 10 números de radicación separados por comas:</label>
                    <textarea id="batch-numbers" class="w-full p-4 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary transition duration-200" placeholder="Ej: 11001418902420250012, ..." rows="4"></textarea>
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="btn-batch-query" class="w-full sm:w-auto bg-primary text-white font-semibold py-3 px-6 rounded-md hover:bg-opacity-90 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-lg flex items-center justify-center">
                        <span class="material-icons mr-2">search</span>
                        Consultar Procesos
                    </button>

                    <button id="btn-api-test" class="w-full sm:w-auto bg-transparent border border-primary text-primary font-semibold py-3 px-6 rounded-md hover:bg-primary hover:text-white transition-colors duration-200 flex items-center justify-center">
                        <span class="material-icons mr-2">api</span>
                        Probar Conexión API
                    </button>
                </div>

                <!-- Progress indicator -->
                <div id="query-progress" class="mt-4 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <div id="progress-text" class="text-sm text-secondary-text-light dark:text-secondary-text-dark">0 de 0 procesos consultados</div>
                        <div id="progress-status" class="text-sm text-secondary-text-light dark:text-secondary-text-dark"></div>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div id="progress-bar" class="h-2 rounded-full bg-primary" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="mt-12">
                <h2 class="text-2xl font-semibold mb-6 text-text-light dark:text-text-dark">Resultados</h2>
                <div id="query-result">
                    <!-- Table and controls will be rendered here by JavaScript -->
                    <div class="table-loading">Cargando resultados...</div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Scripts: reuse existing logic but adapt to new IDs and screen toggles -->
<script>
    // Keep auth token and current user
    let authToken = localStorage.getItem('authToken');
    let currentUser = null;

    const loginScreen = document.getElementById('login-screen');
    const appScreen = document.getElementById('app-screen');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const userEmailSpan = document.getElementById('user-email');

    // Buttons
    const btnBatchQuery = document.getElementById('btn-batch-query');
    const btnApiTest = document.getElementById('btn-api-test');

    // Tabs
    document.getElementById('tab-query').addEventListener('click', () => showTab('query'));
    document.getElementById('tab-saved').addEventListener('click', () => showTab('saved'));
    document.getElementById('tab-logs').addEventListener('click', () => showTab('logs'));

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        if (authToken) {
            // verify token quickly (non-blocking)
            showApp();
            loadUserInfo();
        } else {
            showAuth();
        }
    });

    // Login form submit
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await login();
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
        logout();
    });

    // Wire main action buttons
    btnBatchQuery.addEventListener('click', () => batchQuery());
    btnApiTest.addEventListener('click', () => testAPIConnection());

    // Show/hide helpers
    function showAuth() {
        loginScreen.classList.remove('hidden');
        appScreen.classList.add('hidden');
    }

    function showApp() {
        loginScreen.classList.add('hidden');
        appScreen.classList.remove('hidden');
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if (!email || !password) {
            toast.error('Por favor completa todos los campos');
            return;
        }

        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (response.ok) {
                authToken = data.access_token;
                localStorage.setItem('authToken', authToken);
                showApp();
                await loadUserInfo();
            } else {
                toast.error(data.detail || 'Error en el inicio de sesión');
            }
        } catch (error) {
            toast.error('Error de conexión');
        }
    }

    async function register() {
        // simple register flow to mirror previous behavior
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if (!email || !password) {
            toast.error('Por favor completa todos los campos');
            return;
        }

        try {
            const response = await fetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (response.ok) {
                authToken = data.access_token;
                localStorage.setItem('authToken', authToken);
                showApp();
                await loadUserInfo();
            } else {
                toast.error(data.detail || 'Error en el registro');
            }
        } catch (err) {
            toast.error('Error de conexión');
        }
    }

    async function showRegister(){
        // open register: reuse login inputs but call register instead
        if (await modalConfirm('Registrar con los datos ingresados en el formulario?')) {
            register();
        }
    }

    function logout() {
        authToken = null;
        localStorage.removeItem('authToken');
        currentUser = null;
        userEmailSpan.textContent = '';
        showAuth();
    }

    async function loadUserInfo() {
        if (!authToken) return;
        try {
            const response = await fetch('/auth/me', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (response.ok) {
                currentUser = await response.json();
                userEmailSpan.textContent = ` ${currentUser.email}`;
                // set avatar initials
                const initials = (currentUser.email || 'U').split('@')[0].slice(0,2).toUpperCase();
                document.getElementById('avatar').textContent = initials;
            } else {
                logout();
            }
        } catch (error) {
            console.error('Error loading user info:', error);
        }
    }

    // Tabs handling
    function showTab(tabName){
        // simple client-only switching for demo; could trigger loads
        document.querySelectorAll('#app-screen nav ul li a').forEach(a => a.classList.remove('bg-background-light','dark:bg-background-dark'));
        if(tabName === 'query'){
            // ensure query is visible (we only have one main view so nothing to toggle)
        } else if(tabName === 'saved'){
            loadSavedProcesses();
        } else if(tabName === 'logs'){
            loadLogs();
        }
    }

    async function batchQuery() {
        const raw = document.getElementById('batch-numbers').value.trim();
        if (!raw) {
            toast.error('Por favor ingresa al menos un número de radicación');
            return;
        }
        const numbers = raw.split(',').map(n => n.trim()).filter(n => n);
        if (numbers.length > 10) {
            toast.error('Máximo 10 procesos por consulta');
            return;
        }

        // Validate and normalize
        const validNumbers = [];
        for (const num of numbers) {
            if (num.length !== 23 || !/^\d+$/.test(num)) {
                console.warn(`Formato inesperado para: ${num}`);
                validNumbers.push(num); // include but will likely error server-side
            } else {
                validNumbers.push(num);
            }
        }

        if (validNumbers.length === 0) {
            alert('No hay números válidos para consultar.');
            return;
        }

        // Show progress UI
        const progressContainer = document.getElementById('query-progress');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const progressStatus = document.getElementById('progress-status');
        progressContainer.classList.remove('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = `0 de ${validNumbers.length} procesos consultados`;
        progressStatus.textContent = 'Iniciando consultas...';

        // Ensure debug panel is visible and cleared
        const debugPanel = document.getElementById('debug-panel');
        if (debugPanel) {
            debugPanel.classList.remove('hidden');
            debugPanel.innerHTML = '<h3 class="text-sm font-medium mb-2 text-secondary-text-light dark:text-secondary-text-dark">Debug responses (most recent arriba)</h3>';
        }

        // Make single GET request to /api/procesos?q=...
        try {
            progressStatus.textContent = 'Consultando endpoint batch /api/procesos...';
            const q = validNumbers.join(',');
            const resp = await fetch(`/api/procesos?q=${encodeURIComponent(q)}`, {
                method: 'GET',
                headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
            });

            // Defensive parsing: read text then JSON.parse
            const text = await resp.text();
            let payload;
            try {
                payload = JSON.parse(text);
            } catch (e) {
                console.error('Invalid JSON from /api/procesos:', e, text);
                const container = document.getElementById('query-result');
                container.innerHTML = `<div class="table-error">Respuesta inválida del servidor.</div>`;
                progressStatus.textContent = 'Error';
                progressBar.style.width = '0%';
                if (debugPanel) {
                    const entry = document.createElement('div');
                    entry.style.whiteSpace = 'pre-wrap';
                    entry.style.fontSize = '12px';
                    entry.style.padding = '8px';
                    entry.style.marginBottom = '8px';
                    entry.style.background = 'rgba(255,0,0,0.03)';
                    entry.style.borderRadius = '6px';
                    entry.style.color = '#f8d7da';
                    entry.innerText = `[${new Date().toLocaleTimeString()}] BATCH -> INVALID_JSON\n${text}`;
                    debugPanel.insertBefore(entry, debugPanel.children[1] || null);
                }
                setTimeout(() => progressContainer.classList.add('hidden'), 1200);
                return;
            }

            // Append raw batch response to debug panel
            if (debugPanel) {
                const entry = document.createElement('div');
                entry.style.whiteSpace = 'pre-wrap';
                entry.style.fontSize = '12px';
                entry.style.padding = '8px';
                entry.style.marginBottom = '8px';
                entry.style.background = resp.ok ? 'rgba(255,255,255,0.02)' : 'rgba(255,0,0,0.03)';
                entry.style.borderRadius = '6px';
                entry.style.color = '#cbd5e1';
                entry.innerText = `[${new Date().toLocaleTimeString()}] BATCH -> ${text}`;
                debugPanel.insertBefore(entry, debugPanel.children[1] || null);
            }

            if (!resp.ok) {
                // Server returned an error
                console.error('Batch endpoint returned HTTP error', resp.status, payload);
                progressStatus.textContent = `Error batch: ${resp.status}`;
                progressBar.style.width = '0%';
                // Show error to user and stop
                const container = document.getElementById('query-result');
                container.innerHTML = `<div class="table-error">Error al consultar el endpoint batch: ${payload?.detail || resp.status}</div>`;
                setTimeout(() => progressContainer.classList.add('hidden'), 1200);
                return;
            }

            // Validate payload shape
            if (!payload || !Array.isArray(payload.rows)) {
                console.error('Batch endpoint returned unexpected payload', payload);
                const container = document.getElementById('query-result');
                container.innerHTML = `<div class="table-error">Respuesta inesperada del servidor.</div>`;
                progressStatus.textContent = 'Error';
                setTimeout(() => progressContainer.classList.add('hidden'), 1200);
                return;
            }

            // Normalize rows for table
            const rows = payload.rows.map(normalizaRowParaTabla);

            // Set UI state based on statuses
            if (rows.length > 0) {
                const anyNotSin = rows.some(r => (r.status || '') !== 'SIN_RESULTADOS');
                progressStatus.textContent = anyNotSin ? 'Completado' : 'Sin resultados';
            } else {
                progressStatus.textContent = 'Sin resultados';
            }

            // Render results using normalized rows
            displayBatchResults(rows);
            progressBar.style.width = '100%';
            progressText.textContent = `${rows.length} de ${validNumbers.length} procesos consultados`;
            setTimeout(() => progressContainer.classList.add('hidden'), 1200);
            return;

        } catch (err) {
            console.error('Error calling /api/procesos:', err);
            if (debugPanel) {
                const entry = document.createElement('div');
                entry.style.whiteSpace = 'pre-wrap';
                entry.style.fontSize = '12px';
                entry.style.padding = '8px';
                entry.style.marginBottom = '8px';
                entry.style.background = 'rgba(255,0,0,0.03)';
                entry.style.borderRadius = '6px';
                entry.style.color = '#f8d7da';
                entry.innerText = `[${new Date().toLocaleTimeString()}] BATCH_FAIL -> EXCEPTION: ${String(err)}`;
                debugPanel.insertBefore(entry, debugPanel.children[1] || null);
            }

            const container = document.getElementById('query-result');
            container.innerHTML = `<div class="table-error">No se pudo conectar al endpoint batch. Intenta más tarde.</div>`;
            progressStatus.textContent = 'Error';
            progressBar.style.width = '0%';
            setTimeout(() => progressContainer.classList.add('hidden'), 1200);
            return;
        }
    }

    // Store last results for sorting / re-render
    let lastResults = [];
    let allResults = [];
    let filteredResults = [];
    let currentPage = 1;
    let pageSize = 25;

    function renderResultsTable(results) {
        const container = document.getElementById('query-result');
        if (!results || results.length === 0) {
            container.innerHTML = '<div class="table-empty">No hay resultados.</div>';
            return;
        }

        // Controls for filter and pagination (above table)
        const controlsHtml = `
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                <div class="flex items-center gap-4">
                    <label for="table-filter" class="text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark">Filtrar:</label>
                    <input id="table-filter" type="text" placeholder="Buscar en resultados..." class="px-3 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-primary focus:border-primary" oninput="filterTable()">
                </div>
                <div class="flex items-center gap-4">
                    <label for="table-page-size" class="text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark">Mostrar:</label>
                    <select id="table-page-size" class="px-3 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-primary focus:border-primary" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
        `;

        // Table with correct columns
        const tableHtml = `
            <div class="table-container">
                <table id="results-table" role="table" aria-label="Resultados de consulta de procesos judiciales">
                    <thead>
                        <tr>
                            <th scope="col" onclick="sortTable('radicado')" style="cursor:pointer;" aria-sort="none">Radicado</th>
                            <th scope="col" onclick="sortTable('demandante')" style="cursor:pointer;" aria-sort="none">Demandante</th>
                            <th scope="col" onclick="sortTable('demandado')" style="cursor:pointer;" aria-sort="none">Demandado</th>
                            <th scope="col" onclick="sortTable('juzgado')" style="cursor:pointer;" aria-sort="none">Juzgado</th>
                            <th scope="col" onclick="sortTable('clase')" style="cursor:pointer;" aria-sort="none">Clase</th>
                            <th scope="col" onclick="sortTable('subclase')" style="cursor:pointer;" aria-sort="none">Subclase</th>
                            <th scope="col" onclick="sortTable('ubicacion')" style="cursor:pointer;" aria-sort="none">Ubicación</th>
                            <th scope="col">Última actuación</th>
                            <th scope="col">Guardar</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                    </tbody>
                </table>
                <div id="pagination-controls" class="flex justify-center items-center gap-2 mt-4"></div>
            </div>
        `;

        container.innerHTML = controlsHtml + tableHtml;

        // Initialize pagination and filtering
        allResults = [...results];
        filteredResults = [...results];
        currentPage = 1;
        pageSize = parseInt(document.getElementById('table-page-size').value) || 25;
        renderTablePage();
    }

    // Filter table based on input
    function filterTable() {
        const filterValue = document.getElementById('table-filter').value.toLowerCase();
        filteredResults = allResults.filter(proc =>
            (proc.radicado || '').toLowerCase().includes(filterValue) ||
            (proc.demandante || '').toLowerCase().includes(filterValue) ||
            (proc.demandado || '').toLowerCase().includes(filterValue) ||
            (proc.juzgado || '').toLowerCase().includes(filterValue) ||
            (proc.clase || '').toLowerCase().includes(filterValue) ||
            (proc.subclase || '').toLowerCase().includes(filterValue) ||
            (proc.ubicacion || '').toLowerCase().includes(filterValue)
        );
        currentPage = 1;
        renderTablePage();
    }

    // Change page size
    function changePageSize() {
        pageSize = parseInt(document.getElementById('table-page-size').value);
        currentPage = 1;
        renderTablePage();
    }

    // Render current page of results
    function renderTablePage() {
        const tbody = document.getElementById('results-tbody');
        tbody.innerHTML = '';

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageResults = filteredResults.slice(startIndex, endIndex);

        pageResults.forEach(proc => {
            const demandante = proc.demandante || 'N/A';
            const demandado = proc.demandado || 'N/A';
            const juzgado = proc.juzgado || 'Información no disponible.';
            const clase = proc.clase || 'N/A';
            const subclase = proc.subclase || 'N/A';
            const ubicacion = proc.ubicacion || 'N/A';
            const fecha = normalizaFecha(proc.fechaUltimaActuacion); // Use helper for formatting

            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700 hover:bg-background-light dark:hover:bg-background-dark transition-colors duration-200';

            // Build row with tooltip on radicado
            const encodedProc = encodeURIComponent(JSON.stringify(proc));
            row.innerHTML = `
                <th class="px-6 py-4 font-medium text-text-light dark:text-text-dark whitespace-nowrap" scope="row" title="idProceso: ${proc.idProceso || 'N/A'}">
                    ${escapeHtml(proc.radicado)}
                </th>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(demandante)}</span><span class="full-text">${escapeHtml(demandante)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(demandado)}</span><span class="full-text">${escapeHtml(demandado)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(juzgado)}</span><span class="full-text">${escapeHtml(juzgado)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(clase)}</span><span class="full-text">${escapeHtml(clase)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(subclase)}</span><span class="full-text">${escapeHtml(subclase)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(ubicacion)}</span><span class="full-text">${escapeHtml(ubicacion)}</span></td>
                <td class="px-6 py-4">${escapeHtml(fecha)}</td>
                <td class="px-6 py-4 text-right">
                    ${proc.error ? `<span class="text-red-500 text-xs">${proc.error}</span>` : `
                    <button class="font-medium text-primary hover:underline flex items-center gap-1" onclick="saveProcess(this, '${proc.radicado}', '${encodedProc}')">
                        <span class="material-icons text-sm">bookmark_add</span>
                        Guardar
                    </button>
                    `}
                </td>
            `;
            tbody.appendChild(row);
        });

        // Add pagination controls if needed
        const totalPages = Math.ceil(filteredResults.length / pageSize);
        const paginationControls = document.getElementById('pagination-controls');

        if (totalPages > 1) {
            const paginationHtml = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="px-3 py-1 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded text-sm">Anterior</button>
                <span class="text-sm text-secondary-text-light dark:text-secondary-text-dark">Página ${currentPage} de ${totalPages}</span>
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} class="px-3 py-1 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded text-sm">Siguiente</button>
            `;
            paginationControls.innerHTML = paginationHtml;
        } else {
            paginationControls.innerHTML = '';
        }
    }

    // Change page
    function changePage(page) {
        const totalPages = Math.ceil(filteredResults.length / pageSize);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderTablePage();
        }
    }

    function displayBatchResults(results){
        // Normalize results to the expected structure and sanitize values to avoid "Not Found" / "N/A" leaking
        const normalize = (v) => {
            if (v === null || v === undefined) return '';
            if (typeof v === 'string') {
                const t = v.trim();
                if (!t) return '';
                // Normalize common placeholders
                if (t.toLowerCase() === 'not found' || t === 'N/A') return '';
                return t;
            }
            return String(v);
        };
    
        allResults = results.map(r => {
            return {
                radicado: r.radicado || r.numero || '',
                idProceso: r.idProceso || r.id_proceso || '',
                demandante: normalize(r.demandante),
                demandado: normalize(r.demandado),
                juzgado: normalize(r.juzgado || r.despacho),
                clase: normalize(r.clase || r.clase_proceso),
                subclase: normalize(r.subclase || r.subclase_proceso),
                ubicacion: normalize(r.ubicacion),
                // Keep date as ISO string or null (render layer will show "N/A" safely)
                fechaUltimaActuacion: r.fechaUltimaActuacion || r.fecha_ultima_actuacion || null,
                _raw: r._raw || null // Keep raw data for debug if needed
            };
        });
        renderResultsTable(allResults);
    }

    // Simple sort implementation (toggles asc/desc)
    let currentSort = { col: null, dir: 1 }; // 1 asc, -1 desc
    function sortTable(col){
        if (!col) return;
        
        // Update aria-sort attributes
        document.querySelectorAll('#results-table th').forEach(th => {
            if (th.onclick && th.onclick.toString().includes(`sortTable('${col}')`)) {
                th.setAttribute('aria-sort', currentSort.col === col && currentSort.dir === 1 ? 'ascending' : 'descending');
            } else {
                th.setAttribute('aria-sort', 'none');
            }
        });

        if (currentSort.col === col) currentSort.dir = -currentSort.dir;
        else { currentSort.col = col; currentSort.dir = 1; }

        allResults.sort((a,b) => {
            const va = (a[col] || '').toString().toLowerCase();
            const vb = (b[col] || '').toString().toLowerCase();
            if (va < vb) return -1 * currentSort.dir;
            if (va > vb) return 1 * currentSort.dir;
            return 0;
        });
        filteredResults = [...allResults];
        currentPage = 1;
        renderTablePage();
    }

    // Helper to POST saved process to backend
    // New signature: saveProcess(buttonElement, radicado, procString)
    // Shows a modal allowing the user to optionally assign the saved expediente to a project.
    async function saveProcess(btn, radicado, procString) {
        if (!authToken) {
            toast.error('Debes iniciar sesión para guardar procesos.');
            showAuth();
            return;
        }
    
        // parse the row payload early
        let proc = {};
        try {
            proc = JSON.parse(decodeURIComponent(procString));
        } catch (e) {
            console.error('Invalid procString:', e);
            toast.error('Error interno: datos inválidos');
            return;
        }
    
        // Disable source button to avoid double clicks
        if (btn && typeof btn.setAttribute === 'function') {
            btn.setAttribute('disabled', 'true');
        }
    
        let projects = [];
        try {
            // Load projects to populate modal select
            const r = await fetch('/api/projects', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const j = await r.json().catch(() => null);
            if (r.ok && j && Array.isArray(j.projects)) {
                projects = j.projects;
            } else {
                // If projects can't be loaded, proceed with empty list (user can still save without project)
                console.warn('Failed to load projects for save modal', j);
                projects = [];
            }
        } catch (e) {
            console.warn('Error loading projects', e);
            projects = [];
        }
    
        try {
            // Show modal to let user pick a project (or cancel)
            const selectedProjectId = await showSaveModal(radicado, projects);
            // selectedProjectId:
            //  - undefined => user cancelled
            //  - null => confirmed "Sin proyecto"
            //  - value => project id selected
            if (selectedProjectId === undefined) {
                // user cancelled
                return;
            }
    
            // Build payload to send to /api/saved (same normalization used previously)
            const payload = {
                radicado: proc.radicado || radicado,
                id_proceso: proc.idProceso || proc.id_proceso || '',
                fecha_ultima_actuacion: proc.fechaUltimaActuacion || proc.fecha_ultima_actuacion || null,
                despacho: proc.juzgado || proc.despacho || '',
                departamento: proc.departamento || null,
                demandante: proc.demandante || '',
                demandado: proc.demandado || '',
                response_json: proc._raw ? proc._raw.consulta || null : null,
                detalle_json: proc._raw ? proc._raw.detalle || null : null,
                tipo_proceso: proc.clase || proc.clase_proceso || '',
                clase_proceso: proc.clase || proc.clase_proceso || '',
                subclase_proceso: proc.subclase || proc.subclase_proceso || '',
                ubicacion: proc.ubicacion || ''
            };
    
            // Disable modal confirm button by temporarily setting modal-confirm to disabled (defensive)
            const modalConfirmBtn = document.getElementById('modal-confirm');
            if (modalConfirmBtn) modalConfirmBtn.setAttribute('disabled', 'true');
    
            // 1) Save to /api/saved
            const resp = await fetch('/api/saved', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    radicado: payload.radicado,
                    id_proceso: payload.id_proceso,
                    fecha_ultima_actuacion: payload.fecha_ultima_actuacion,
                    despacho: payload.despacho,
                    departamento: payload.departamento,
                    demandante: payload.demandante,
                    demandado: payload.demandado,
                    response_json: payload.response_json,
                    detalle_json: payload.detalle_json,
                    tipo_proceso: payload.tipo_proceso,
                    clase_proceso: payload.clase_proceso,
                    subclase_proceso: payload.subclase_proceso,
                    ubicacion: payload.ubicacion
                })
            });
            const data = await resp.json().catch(() => null);
            if (!resp.ok || !data || data.status !== 'OK') {
                // Save failed
                toast.error(`No se pudo guardar: ${data?.detail || resp.status || 'Error'}`);
                return;
            }
    
            const savedId = data.saved?.id;
    
            // 2) If project selected, link it
            if (selectedProjectId) {
                try {
                    const linkResp = await fetch(`/api/projects/${selectedProjectId}/cases`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ savedProcessId: savedId })
                    });
                    const linkData = await linkResp.json().catch(() => null);
                    if (linkResp.ok) {
                        // find project name for toast
                        const p = projects.find(pp => String(pp.id) === String(selectedProjectId));
                        const projName = p ? p.name : 'proyecto seleccionado';
                        toast.success(`Expediente guardado. Asignado al proyecto ${projName}`);
                    } else {
                        // Linking failed but saved exists
                        toast.success('Expediente guardado');
                        toast.error(`No se pudo asignar al proyecto: ${linkData?.detail || linkResp.status}`);
                    }
                } catch (linkErr) {
                    console.error('Error linking saved process to project', linkErr);
                    toast.success('Expediente guardado');
                    toast.error('No se pudo asignar al proyecto (error de conexión)');
                }
            } else {
                // No project chosen
                toast.success('Expediente guardado');
            }
    
            // Visual mark on row (if present)
            try {
                const row = btn ? btn.closest('tr') : null;
                if (row) {
                    const th = row.querySelector('th[scope="row"]');
                    if (th && !th.querySelector('.saved-check .material-icons')) {
                        const span = document.createElement('span');
                        span.className = 'material-icons text-green-500 text-base saved-check';
                        span.style.marginLeft = '6px';
                        span.title = 'Guardado';
                        span.textContent = 'check_circle';
                        th.appendChild(span);
                    }
                }
            } catch (e) {
                console.warn('Could not mark saved row visually', e);
            }
    
            // If saved tab active, refresh saved list
            if (document.getElementById('tab-saved') && document.getElementById('tab-saved').classList.contains('active')) {
                await loadSavedProcesses();
            }
    
        } catch (err) {
            console.error('saveProcess error:', err);
            toast.error(err?.message || 'Error guardando proceso (ver consola).');
        } finally {
            // Re-enable modal confirm & source button
            try {
                const modalConfirmBtn2 = document.getElementById('modal-confirm');
                if (modalConfirmBtn2) modalConfirmBtn2.removeAttribute('disabled');
            } catch (e) { /* ignore */ }
            if (btn && typeof btn.removeAttribute === 'function') {
                btn.removeAttribute('disabled');
            }
        }
    }

    // Utility to escape HTML in table cells
    function escapeHtml(text){
        if (text === null || text === undefined) return '';
        return String(text)
            .replace(/&/g, '&')
            .replace(/</g, '<')
            .replace(/>/g, '>')
            .replace(/"/g, '"')
            .replace(/'/g, '&#039;');
    }

    // Normalize date values for table display.
    // Accepts:
    //  - DD/MM/YYYY -> returned as-is
    //  - YYYY-MM-DD or YYYY-MM-DDTHH:MM:SSZ -> converted to DD/MM/YYYY
    //  - null/empty -> 'N/A'
    function normalizaFecha(value) {
        if (value === null || value === undefined) return 'N/A';
        if (typeof value !== 'string') value = String(value);

        const v = value.trim();
        if (!v) return 'N/A';

        // Already DD/MM/YYYY
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return v;

        // YYYY-MM-DD or YYYY-MM-DDTHH:MM:SS...
        const isoDateMatch = v.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s].*)?$/);
        if (isoDateMatch) {
            const yyyy = isoDateMatch[1];
            const mm = isoDateMatch[2];
            const dd = isoDateMatch[3];
            return `${dd}/${mm}/${yyyy}`;
        }

        // Fallback: try Date parser
        try {
            const d = new Date(v);
            if (isNaN(d.getTime())) return 'N/A';
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        } catch (e) {
            return 'N/A';
        }
    }

    // Normalize a backend row into the exact table-facing keys required:
    // { radicado, idProceso, demandante, demandado, juzgado, clase, subclase, ubicacion, fechaUltimaActuacion, status, error?, _raw? }
    function normalizaRowParaTabla(row) {
        if (!row || typeof row !== 'object') return {
            radicado: '',
            idProceso: '',
            demandante: '',
            demandado: '',
            juzgado: '',
            clase: '',
            subclase: '',
            ubicacion: '',
            fechaUltimaActuacion: null,
            status: '',
            error: '',
            _raw: null
        };

        return {
            radicado: row.radicado || '',
            idProceso: row.idProceso || '',
            demandante: row.demandante || '',
            demandado: row.demandado || '',
            juzgado: row.juzgado || '',
            clase: row.clase || '',
            subclase: row.subclase || '',
            ubicacion: row.ubicacion || '',
            // Keep original raw date string; rendering layer will call normalizaFecha()
            fechaUltimaActuacion: row.fechaUltimaActuacion || null,
            status: row.status || '',
            error: row.error || '',
            _raw: row._raw || null
        };
    }

    // Helper to format date to DD/MM/YYYY (defensive: avoids NaN/NaN/NaN)
    function formateaFecha(iso) {
        if (!iso) return 'N/A';
        // If already formatted as DD/MM/YYYY return it
        if (typeof iso === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(iso.trim())) return iso.trim();
        if (iso === 'N/A') return 'N/A';
        try {
            const d = new Date(iso);
            if (isNaN(d.getTime())) return 'N/A';
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        } catch (e) {
            console.error("Error formatting date:", iso, e);
            return 'N/A';
        }
    }

    // Helper to parse sujetosProcesales
    function parseSujetos(s) {
        if (!s) return { demandante: 'N/A', demandado: 'N/A' };
        const parts = s.split('|').map(x => x.trim());
        const ds = [], dd = [];
        for (const p of parts) {
            const lower = p.toLowerCase();
            if (lower.startsWith('demandante:')) ds.push(p.split(':')[1].trim());
            if (lower.startsWith('demandado:')) dd.push(p.split(':')[1].trim());
        }
        return {
            demandante: ds.length ? ds.join(', ') : 'N/A',
            demandado: dd.length ? dd.join(', ') : 'N/A',
        };
    }

    async function testAPIConnection(){
        try{
            const response = await fetch('/api-test');
            const data = await response.json();
            if(response.ok && data.status === 'success'){
                toast.success('Conexión API exitosa');
            } else {
                toast.error('Error al conectar con la API');
            }
        } catch(err){
            toast.error('Error de conexión');
        }
    }

    // Saved processes and logs (light implementations)
    // Helper: map saved API row to the table-facing row object
    function mapSavedRowToTableRow(saved) {
        return {
            radicado: saved.numero || saved.radicado || '',
            idProceso: saved.id_proceso || saved.idProceso || saved.id || '',
            demandante: saved.demandante || '',
            demandado: saved.demandado || '',
            juzgado: saved.despacho || saved.juzgado || '',
            clase: saved.clase_proceso || saved.clase || '',
            subclase: saved.subclase_proceso || saved.subclase || '',
            ubicacion: saved.ubicacion || '',
            fechaUltimaActuacion: saved.fecha || saved.fecha_ultima_actuacion || saved.fechaUltimaActuacion || null,
            _raw: saved._raw || null,
            // expose metadata
            savedId: saved.id || saved._id || null,
            updatedAt: saved.updatedAt || saved.updated_at || saved.updated || null
        };
    }

    // Helper: format incoming date either DD/MM/YYYY or ISO -> DD/MM/YYYY; null -> 'N/A'
    function formatDateToDisplay(isoOrDDMMYYYY) {
        if (!isoOrDDMMYYYY || isoOrDDMMYYYY === null) return 'N/A';
        if (typeof isoOrDDMMYYYY !== 'string') isoOrDDMMYYYY = String(isoOrDDMMYYYY);

        const v = isoOrDDMMYYYY.trim();
        if (!v) return 'N/A';
        // If already DD/MM/YYYY
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return v;
        // If ISO-like YYYY-MM-DD
        const isoMatch = v.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (isoMatch) {
            return `${isoMatch[3]}/${isoMatch[2]}/${isoMatch[1]}`;
        }
        // Fallback to Date parse
        try {
            const d = new Date(v);
            if (isNaN(d.getTime())) return 'N/A';
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        } catch (e) {
            return 'N/A';
        }
    }

    // Projects (Mis Procesos) view (replaces previous "Procesos Guardados" screen)
    // This function keeps the original name loadSavedProcesses to avoid changing other callers.
    async function loadSavedProcesses(){
        if(!authToken) {
            showAuth();
            return;
        }
        const container = document.getElementById('query-result');
        container.innerHTML = '<div class="table-loading">Cargando proyectos...</div>';
    
        try{
            const resp = await fetch('/api/projects', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const data = await resp.json();
    
            if (!resp.ok) {
                if (resp.status === 503) {
                    toast.error(data?.detail || 'No se puede acceder a proyectos ahora');
                    container.innerHTML = `<div class="table-error">${data?.detail || 'No se puede acceder a proyectos ahora'}</div>`;
                    return;
                }
                container.innerHTML = `<div class="table-error">Error cargando proyectos: ${data.detail || 'Error desconocido'}</div>`;
                console.error('Error cargando proyectos:', data);
                return;
            }
    
            const projects = Array.isArray(data.projects) ? data.projects : [];
    
            // Build projects grid (responsive)
            const gridHtmlStart = `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">`;
            const gridHtmlEnd = `</div>`;
            const cardHtml = projects.map(p => {
                const color = p.colorHex || '#2563EB';
                // small helpers for inline style (tint background)
                const rgba = hexToRgba(color, 0.08);
                const border = color;
                const updated = p.updatedAt ? formatDateToDisplay(p.updatedAt) : 'N/A';
                return `
                    <div class="p-4 rounded-lg" data-project-id="${p.id}" style="background:${rgba}; border:1px solid ${border};">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="material-icons">folder</span>
                                    <h3 class="font-semibold text-lg">${escapeHtml(p.name)}</h3>
                                </div>
                                <p class="text-sm text-secondary-text-light dark:text-secondary-text-dark mt-2">
                                    <span title="Total expedientes" class="inline-flex items-center gap-2">
                                        <span class="material-icons text-sm">inventory_2</span>
                                        ${p.total || p.total === 0 ? p.total : 0}
                                    </span>
                                    <span class="ml-4 inline-flex items-center gap-2" title="Fecha de última actualización">
                                        <span class="material-icons text-sm">calendar_today</span>
                                        Act: ${escapeHtml(updated)}
                                    </span>
                                </p>
                            </div>
                            <div class="relative">
                                <button class="project-kebab-btn" data-project-id="${p.id}" aria-label="menu">⋮</button>
                                <div class="project-kebab-menu hidden absolute right-0 mt-2 w-44 bg-panel-light dark:bg-panel-dark rounded shadow-md z-40 p-2">
                                    <button class="w-full text-left px-2 py-2 hover:bg-background-light dark:hover:bg-background-dark btn-rename" data-project-id="${p.id}">Renombrar</button>
                                    <button class="w-full text-left px-2 py-2 hover:bg-background-light dark:hover:bg-background-dark btn-color" data-project-id="${p.id}" data-color="${p.colorHex}">Cambiar color</button>
                                    <button class="w-full text-left px-2 py-2 hover:bg-background-light dark:hover:bg-background-dark text-red-500 btn-delete" data-project-id="${p.id}">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
    
            // "Nuevo proyecto" card
            const newCard = `
                <div class="p-4 rounded-lg flex items-center justify-center cursor-pointer hover:scale-102" id="new-project-card" style="border:1px dashed rgba(255,255,255,0.06);">
                    <div class="text-center">
                        <div class="text-3xl text-primary mb-2">+</div>
                        <div class="text-sm">Nuevo proyecto</div>
                    </div>
                </div>
            `;
    
            container.innerHTML = gridHtmlStart + newCard + cardHtml + gridHtmlEnd;
    
            // Attach handlers
            document.getElementById('new-project-card').addEventListener('click', async () => {
                const name = await modalPrompt('Nombre del nuevo proyecto:');
                if (!name || !name.trim()) {
                    toast.error('Nombre inválido');
                    return;
                }
                const payload = { name: name.trim(), colorHex: '#2563EB' };
                try {
                    const r = await fetch('/api/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify(payload)
                    });
                    const j = await r.json();
                    if (r.ok) {
                        toast.success('Proyecto creado');
                        await loadSavedProcesses();
                    } else {
                        toast.error(j?.detail || 'Error creando proyecto');
                    }
                } catch (e) {
                    console.error('Error creating project', e);
                    toast.error('Error de conexión');
                }
            });
    
            // Card click -> open project detail
            document.querySelectorAll('[data-project-id]').forEach(el => {
                // Avoid attaching to kebab buttons
                if (el.id === 'new-project-card') return;
                el.addEventListener('click', (ev) => {
                    // if clicked on kebab or menu, ignore
                    if (ev.target.closest('.project-kebab-btn') || ev.target.closest('.project-kebab-menu') ) return;
                    const pid = el.getAttribute('data-project-id');
                    if (pid) loadProjectDetail(pid);
                });
            });
    
            // Kebab menu toggle & actions
            document.querySelectorAll('.project-kebab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const pid = btn.dataset.projectId;
                    const menu = btn.parentElement.querySelector('.project-kebab-menu');
                    if (menu) menu.classList.toggle('hidden');
                });
            });
    
            // Rename
            document.querySelectorAll('.btn-rename').forEach(b => {
                b.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const pid = b.dataset.projectId;
                    const currentName = b.closest('[data-project-id]') ? b.closest('[data-project-id]').querySelector('h3')?.textContent : '';
                    const newName = await modalPrompt('Nuevo nombre del proyecto:', currentName || '');
                    if (!newName || !newName.trim()) { toast.error('Nombre inválido'); return; }
                    try {
                        const r = await fetch(`/api/projects/${pid}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                            body: JSON.stringify({ name: newName.trim() })
                        });
                        const j = await r.json();
                        if (r.ok) {
                            toast.success('Renombrado');
                            await loadSavedProcesses();
                        } else {
                            toast.error(j?.detail || 'Error renombrando');
                        }
                    } catch (err) {
                        console.error(err);
                        toast.error('Error de conexión');
                    }
                });
            });
    
            // Change color
            document.querySelectorAll('.btn-color').forEach(b => {
                b.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const pid = b.dataset.projectId;
                    const currentColor = b.dataset.color || '#2563EB';
                    const newColor = await modalPrompt('Color hexadecimal (ej: #2563EB):', currentColor);
                    if (!newColor || !/^#([0-9A-Fa-f]{6})$/.test(newColor.trim())) { toast.error('Color inválido'); return; }
                    try {
                        const r = await fetch(`/api/projects/${pid}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                            body: JSON.stringify({ colorHex: newColor.trim() })
                        });
                        const j = await r.json();
                        if (r.ok) {
                            toast.success('Color actualizado');
                            await loadSavedProcesses();
                        } else {
                            toast.error(j?.detail || 'Error actualizando color');
                        }
                    } catch (err) {
                        console.error(err);
                        toast.error('Error de conexión');
                    }
                });
            });
    
            // Delete
            document.querySelectorAll('.btn-delete').forEach(b => {
                b.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const pid = b.dataset.projectId;
                    if (!(await modalConfirm('Eliminar proyecto y desvincular expedientes?'))) return;
                    try {
                        const r = await fetch(`/api/projects/${pid}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        const j = await r.json().catch(()=>null);
                        if (r.ok) {
                            toast.success('Proyecto eliminado');
                            await loadSavedProcesses();
                        } else {
                            toast.error(j?.detail || 'Error eliminando proyecto');
                        }
                    } catch (err) {
                        console.error(err);
                        toast.error('Error de conexión');
                    }
                });
            });
    
        } catch(err){
            console.error('Error cargando proyectos:', err);
            toast.error('Error de conexión al cargar proyectos.');
            container.innerHTML = `<div class="table-error">Error de conexión al cargar proyectos.</div>`;
        }
    }
    
    // Helper: convert hex to rgba with alpha (simple)
    function hexToRgba(hex, alpha=0.08) {
        try {
            const h = hex.replace('#','');
            const r = parseInt(h.substring(0,2),16);
            const g = parseInt(h.substring(2,4),16);
            const b = parseInt(h.substring(4,6),16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        } catch(e){
            return `rgba(37,99,235, ${alpha})`;
        }
    }
    
    // Load project detail (cases table)
    async function loadProjectDetail(projectId) {
        if(!authToken) { showAuth(); return; }
        const container = document.getElementById('query-result');
        container.innerHTML = '<div class="table-loading">Cargando proyecto...</div>';
        try {
            const resp = await fetch(`/api/projects/${projectId}/cases`, { headers: { 'Authorization': `Bearer ${authToken}` }});
            const data = await resp.json();
            if (!resp.ok) {
                toast.error(data?.detail || 'Error cargando proyecto');
                container.innerHTML = `<div class="table-error">${data?.detail || 'Error cargando proyecto'}</div>`;
                return;
            }
            const cases = data.cases || [];
            // Breadcrumb & toolbar
            const toolbar = `
                <div class="flex items-center justify-between mb-4">
                    <div class="text-sm text-secondary-text-light dark:text-secondary-text-dark">Mis Procesos / <strong>Proyecto ${escapeHtml(String(projectId))}</strong></div>
                    <div class="flex items-center gap-2">
                        <button id="btn-refresh-selected-proj" class="bg-primary text-white px-3 py-2 rounded">Actualizar seleccionados</button>
                        <button id="btn-refresh-all-proj" class="bg-transparent border border-primary text-primary px-3 py-2 rounded">Actualizar todos</button>
                        <button id="btn-add-case" class="bg-primary text-white px-3 py-2 rounded">Añadir expediente</button>
                    </div>
                </div>
            `;
            const tableHtmlStart = `
                <div class="table-container">
                    <table id="project-cases-table" role="table" aria-label="Expedientes del proyecto">
                        <thead>
                            <tr>
                                <th scope="col"><input id="check-all-project" type="checkbox" /></th>
                                <th scope="col">Radicado</th>
                                <th scope="col">Demandante</th>
                                <th scope="col">Demandado</th>
                                <th scope="col">Juzgado</th>
                                <th scope="col">Clase</th>
                                <th scope="col">Subclase</th>
                                <th scope="col">Ubicación</th>
                                <th scope="col">Fecha Última Actuación</th>
                                <th scope="col">Actualizado el</th>
                                <th scope="col">Opciones</th>
                            </tr>
                        </thead>
                        <tbody id="project-cases-tbody">
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = toolbar + tableHtmlStart;
            const tbody = document.getElementById('project-cases-tbody');
            for (const c of cases) {
                const updated = c.updatedAt || 'N/A';
                const fecha = c.fechaUltimaActuacion || 'N/A';
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-gray-700';
                row.dataset.caseId = c.id;
                row.innerHTML = `
                    <td class="px-4 py-2 text-center"><input class="proj-checkbox" type="checkbox" data-id="${c.id}" /></td>
                    <td class="px-6 py-4 font-medium text-text-light dark:text-text-dark whitespace-nowrap" title="idProceso: ${c.idProceso || 'N/A'}">${escapeHtml(c.radicado || '')}</td>
                    <td class="px-6 py-4 truncate-cell" data-col="demandante">${escapeHtml(c.demandante || '')}</td>
                    <td class="px-6 py-4 truncate-cell" data-col="demandado">${escapeHtml(c.demandado || '')}</td>
                    <td class="px-6 py-4 truncate-cell" data-col="juzgado">${escapeHtml(c.juzgado || '')}</td>
                    <td class="px-6 py-4 truncate-cell" data-col="clase">${escapeHtml(c.clase || '')}</td>
                    <td class="px-6 py-4 truncate-cell" data-col="subclase">${escapeHtml(c.subclase || '')}</td>
                    <td class="px-6 py-4 truncate-cell" data-col="ubicacion">${escapeHtml(c.ubicacion || '')}</td>
                    <td class="px-6 py-4" data-col="fechaUltimaActuacion">${escapeHtml(fecha)}</td>
                    <td class="px-6 py-4 text-sm text-secondary-text-light" data-col="updatedAt">${escapeHtml(updated)}</td>
                    <td class="px-6 py-4 text-right">
                        <button class="mr-2 px-3 py-1 bg-primary text-white rounded text-sm btn-refresh-row" data-case-id="${c.id}">Actualizar</button>
                        <button class="px-3 py-1 bg-red-600 text-white rounded text-sm btn-delete-row" data-case-id="${c.id}">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
    
            // wire project-level controls
            document.getElementById('btn-add-case').addEventListener('click', async () => {
                const rad = await modalPrompt('Ingrese número de radicación (23 dígitos):');
                if (!rad || !/^\d{23}$/.test(rad.trim())) { toast.error('Radicado inválido'); return; }
                try {
                    const r = await fetch(`/api/projects/${projectId}/cases`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify({ radicado: rad.trim() })
                    });
                    const j = await r.json();
                    if (r.ok) {
                        toast.success('Expediente añadido');
                        await loadProjectDetail(projectId);
                    } else {
                        toast.error(j?.detail || 'Error añadiendo expediente');
                    }
                } catch (e) {
                    console.error(e);
                    toast.error('Error de conexión');
                }
            });
    
            document.getElementById('btn-refresh-all-proj').addEventListener('click', async () => {
                if (!(await modalConfirm('Actualizar todos los expedientes de este proyecto?'))) return;
                try {
                    const r = await fetch(`/api/projects/${projectId}/refresh`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const j = await r.json();
                    if (r.ok) {
                        // highlight changed rows if any
                        if (Array.isArray(j.rows)) {
                            for (const change of j.rows) {
                                if (change.changedFields && change.changedFields.length) {
                                    const tr = document.querySelector(`tr[data-case-id="${change.caseId}"]`);
                                    if (tr) {
                                        for (const cf of change.changedFields) {
                                            const cell = tr.querySelector(`[data-col="${cf}"]`);
                                            if (cell) cell.classList.add('bg-amber-500/10');
                                        }
                                    }
                                    toast.info(`Cambios detectados para ${change.radicado || change.caseId}`);
                                }
                            }
                        }
                        await loadProjectDetail(projectId);
                    } else {
                        toast.error(j?.detail || 'Error actualizando proyecto');
                    }
                } catch (e) {
                    console.error(e);
                    toast.error('Error de conexión');
                }
            });
    
            document.getElementById('btn-refresh-selected-proj').addEventListener('click', async () => {
                const checked = Array.from(document.querySelectorAll('.proj-checkbox:checked')).map(cb => parseInt(cb.dataset.id)).filter(Boolean);
                if (checked.length === 0) {
                    if (!(await modalConfirm('No hay expedientes seleccionados. ¿Deseas actualizar todos?'))) return;
                    // call refresh all
                    document.getElementById('btn-refresh-all-proj').click();
                    return;
                }
                try {
                    const r = await fetch(`/api/projects/${projectId}/refresh-selected`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify({ caseIds: checked })
                    });
                    const j = await r.json();
                    if (r.ok) {
                        if (Array.isArray(j.rows)) {
                            for (const change of j.rows) {
                                if (change.changedFields && change.changedFields.length) {
                                    const tr = document.querySelector(`tr[data-case-id="${change.caseId}"]`);
                                    if (tr) {
                                        for (const cf of change.changedFields) {
                                            const cell = tr.querySelector(`[data-col="${cf}"]`);
                                            if (cell) cell.classList.add('bg-amber-500/10');
                                        }
                                    }
                                    toast.info(`Cambios detectados para ${change.radicado || change.caseId}`);
                                }
                            }
                        }
                        await loadProjectDetail(projectId);
                    } else {
                        toast.error(j?.detail || 'Error actualizando seleccionados');
                    }
                } catch (e) {
                    console.error(e);
                    toast.error('Error de conexión');
                }
            });
    
            // per-row handlers (refresh / delete)
            document.querySelectorAll('.btn-refresh-row').forEach(b => {
                b.addEventListener('click', async () => {
                    const cid = b.dataset.caseId;
                    try {
                        const r = await fetch(`/api/projects/${projectId}/refresh-selected`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                            body: JSON.stringify({ caseIds: [parseInt(cid)] })
                        });
                        const j = await r.json();
                        if (r.ok) {
                            toast.success('Expediente actualizado');
                            await loadProjectDetail(projectId);
                        } else {
                            toast.error(j?.detail || 'Error actualizando expediente');
                        }
                    } catch (e) {
                        console.error(e);
                        toast.error('Error de conexión');
                    }
                });
            });
    
            document.querySelectorAll('.btn-delete-row').forEach(b => {
                b.addEventListener('click', async () => {
                    const cid = b.dataset.caseId;
                    if (!(await modalConfirm('¿Eliminar expediente del proyecto?'))) return;
                    try {
                        const r = await fetch(`/api/projects/${projectId}/cases/${cid}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        const j = await r.json().catch(()=>null);
                        if (r.ok) {
                            toast.success('Expediente eliminado del proyecto');
                            await loadProjectDetail(projectId);
                        } else {
                            toast.error(j?.detail || 'Error eliminando expediente');
                        }
                    } catch (e) {
                        console.error(e);
                        toast.error('Error de conexión');
                    }
                });
            });
    
            // check-all behavior
            const checkAll = document.getElementById('check-all-project');
            if (checkAll) {
                checkAll.addEventListener('change', (e) => {
                    const checked = e.target.checked;
                    document.querySelectorAll('.proj-checkbox').forEach(cb => cb.checked = checked);
                });
            }
    
        } catch (err) {
            console.error('Error cargando proyecto:', err);
            toast.error('Error cargando proyecto');
            container.innerHTML = `<div class="table-error">Error cargando proyecto.</div>`;
        }
    }
    
    // Modal prompt (returns entered string or null if cancelled)
    function modalPrompt(message, defaultValue = '') {
        return new Promise((resolve) => {
            modalResolve = (confirmed) => {
                const input = document.getElementById('modal-input');
                document.getElementById('modal-overlay').classList.add('hidden');
                if (confirmed) {
                    resolve(input ? input.value : defaultValue);
                } else {
                    resolve(null);
                }
            };
            const msgEl = document.getElementById('modal-message');
            msgEl.innerHTML = `<div class="mb-2">${escapeHtml(message)}</div><input id="modal-input" class="w-full px-3 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md" value="${escapeHtml(defaultValue || '')}" />`;
            document.getElementById('modal-overlay').classList.remove('hidden');
            const inputEl = document.getElementById('modal-input');
            if (inputEl) {
                setTimeout(() => inputEl.focus(), 50);
            }
        });
    }

    // Save modal (for assigning a saved expediente to an optional project)
    // Returns:
    //  - undefined if user cancelled
    //  - null if user confirmed with "Sin proyecto"
    //  - projectId (string/number) if user selected a project
    function showSaveModal(radicado, projects) {
        return new Promise((resolve) => {
            modalResolve = (confirmed) => {
                const select = document.getElementById('modal-save-project-select');
                document.getElementById('modal-overlay').classList.add('hidden');
                if (!confirmed) {
                    resolve(undefined);
                    return;
                }
                const val = select ? select.value : '';
                if (!val) resolve(null);
                else resolve(val);
            };
            const msgEl = document.getElementById('modal-message');
            // Build options: first option = Sin proyecto
            let optionsHtml = `<option value="">Sin proyecto</option>`;
            try {
                projects.forEach(p => {
                    optionsHtml += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
                });
            } catch (e) {
                console.warn('showSaveModal: failed building projects options', e);
            }
            msgEl.innerHTML = `
                <div class="mb-2 text-lg font-semibold">Guardar expediente</div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-1">Radicado</label>
                    <input type="text" readonly class="w-full px-3 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md" value="${escapeHtml(radicado)}" />
                </div>
                <div class="mb-2">
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-1">Proyecto (opcional)</label>
                    <select id="modal-save-project-select" class="w-full px-3 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md">${optionsHtml}</select>
                </div>
                <div class="text-sm text-secondary-text-light dark:text-secondary-text-dark mt-2">Selecciona un proyecto para asignar el expediente (opcional).</div>
            `;
            document.getElementById('modal-overlay').classList.remove('hidden');
            // focus select
            setTimeout(() => {
                const sel = document.getElementById('modal-save-project-select');
                if (sel) sel.focus();
            }, 60);
        });
    }

    // Refresh saved processes (ids optional array). Calls POST /api/saved/refresh
    async function refreshSaved(ids) {
        if (!authToken) { showAuth(); return; }
        const progressEl = document.getElementById('progressStatus');
        try {
            progressEl.textContent = 'Iniciando actualización...';
            const body = ids && ids.length ? { ids } : {};
            const resp = await fetch('/api/saved/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(body)
            });
            const data = await resp.json();
            if (!resp.ok) {
                if (resp.status === 503) {
                    toast.error(data?.detail || 'No se puede actualizar ahora');
                    progressEl.textContent = '';
                    return;
                }
                toast.error(data?.detail || 'Error al actualizar procesos');
                progressEl.textContent = '';
                return;
            }

            // data should contain list of diffs per id
            const changes = data.rows || data.results || data.changes || data || [];
            // Show progress count if provided
            if (Array.isArray(changes)) {
                let total = changes.length;
                let processed = 0;
                for (const change of changes) {
                    processed++;
                    progressEl.textContent = `Actualizando ${processed}/${total}...`;
                    if (change.changedFields && change.changedFields.length > 0) {
                        // Highlight row in UI
                        const id = change.id || change.savedId || change.saved_id;
                        const tr = document.querySelector(`tr[data-saved-id="${id}"]`);
                        if (tr) {
                            // add badge
                            const badgeCell = tr.querySelector('.saved-badge');
                            if (badgeCell) badgeCell.innerHTML = `<span class="text-xs text-yellow-300 bg-yellow-900 px-2 py-0.5 rounded">Cambios</span>`;
                            // highlight changed cells
                            for (const cf of change.changedFields) {
                                const cell = tr.querySelector(`[data-col="${cf}"]`);
                                if (cell) {
                                    cell.classList.add('bg-yellow-100', 'dark:bg-yellow-900');
                                }
                            }
                        }
                        // show simple toast summarizing changes
                        try {
                            const summary = change.changedFields.map(f => `${f}: ${JSON.stringify(change.before?.[f])} → ${JSON.stringify(change.after?.[f])}`).join('; ');
                            toast.info(`Cambios detectados para ${change.id || change.savedId || 'id desconocido'}: ${summary}`);
                        } catch (e) {
                            console.warn('Could not build summary toast', e);
                        }
                    }
                }
            } else {
                // If server returned an object with diffs per id
                toast.success('Actualización completada');
            }

            // After refresh, reload saved list to reflect updated snapshots/updatedAt
            await loadSavedProcesses();
            progressEl.textContent = '';
        } catch (err) {
            console.error('Error refreshing saved processes:', err);
            toast.error('Error de conexión al actualizar procesos guardados.');
            const progressEl2 = document.getElementById('progressStatus');
            if (progressEl2) progressEl2.textContent = '';
        }
    }

    // Refresh a single saved process (helper used by "Actualizar" button)
    async function refreshSavedSingle(id) {
        if (!id) return;
        await refreshSaved([id]);
    }

    // Delete saved process
    async function deleteSaved(id, btn) {
        if (!id) return;
        if (!(await modalConfirm('¿Eliminar proceso guardado?'))) return;
        if (!authToken) { showAuth(); return; }
        try {
            const resp = await fetch(`/api/saved/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const data = await resp.json().catch(() => null);
            if (resp.ok) {
                // remove row from UI
                const tr = document.querySelector(`tr[data-saved-id="${id}"]`);
                if (tr && tr.parentElement) tr.parentElement.removeChild(tr);
                toast.success('Eliminado');
            } else {
                if (resp.status === 503) {
                    toast.error(data?.detail || 'No se puede eliminar ahora');
                } else {
                    toast.error(data?.detail || JSON.stringify(data) || 'Error eliminando');
                }
            }
        } catch (err) {
            console.error('deleteSaved error:', err);
            toast.error('Error de conexión al eliminar proceso guardado.');
        }
    }

    async function loadLogs(){
        if(!authToken) return;
        const container = document.getElementById('query-result');
        container.innerHTML = '<div class="table-loading">Cargando logs...</div>';

        try{
            const resp = await fetch('/logs', { headers: { 'Authorization': `Bearer ${authToken}` }});
            const data = await resp.json();
            if(resp.ok){
                if (data.logs && data.logs.length > 0) {
                    // Display logs in a pre-formatted block, not a table for now
                    container.innerHTML = `
                        <div class="bg-panel-light dark:bg-panel-dark p-6 rounded-lg shadow-md overflow-x-auto">
                            <h3 class="text-lg font-semibold mb-4 text-text-light dark:text-text-dark">Historial de Logs</h3>
                            <pre class="text-sm text-secondary-text-light dark:text-secondary-text-dark whitespace-pre-wrap">${JSON.stringify(data.logs, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="table-empty">No hay logs disponibles.</div>';
                }
            } else {
                container.innerHTML = `<div class="table-error">Error cargando logs: ${data.detail || 'Error desconocido'}</div>`;
                console.error('Error cargando logs:', data);
            }
        } catch(e){
            container.innerHTML = `<div class="table-error">Error de conexión al cargar logs.</div>`;
            console.error('Error de conexión al cargar logs:', e);
        }
    }

    // Toast system
    const toast = {
        container: null,
        init() {
            this.container = document.createElement('div');
            this.container.id = 'toast-container';
            this.container.className = 'fixed top-4 right-4 z-50 space-y-2';
            document.body.appendChild(this.container);
        },
        show(message, type = 'info') {
            if (!this.container) this.init();
            const toastEl = document.createElement('div');
            toastEl.className = `p-4 rounded-lg shadow-lg text-white transition-opacity duration-300 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500'
            }`;
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.textContent = message;
            this.container.appendChild(toastEl);
            setTimeout(() => {
                toastEl.style.opacity = '0';
                setTimeout(() => toastEl.remove(), 300);
            }, 3000);
        },
        success(message) { this.show(message, 'success'); },
        error(message) { this.show(message, 'error'); },
        info(message) { this.show(message, 'info'); }
    };

    // Modal confirmation system
    let modalResolve;
    function modalConfirm(message) {
        return new Promise((resolve) => {
            modalResolve = resolve;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-confirm').focus();
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        toast.init();
        document.getElementById('modal-confirm').addEventListener('click', () => {
            document.getElementById('modal-overlay').classList.add('hidden');
            modalResolve(true);
        });
        document.getElementById('modal-cancel').addEventListener('click', () => {
            document.getElementById('modal-overlay').classList.add('hidden');
            modalResolve(false);
        });
    });
</script>

<!-- Toast and Modal Containers -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40 flex items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="modal-message">
    <div id="modal-content" class="bg-panel-light dark:bg-panel-dark p-6 rounded-lg shadow-lg max-w-md w-full mx-4 text-text-light dark:text-text-dark">
        <p id="modal-message" class="mb-4"></p>
        <div class="flex justify-end gap-4">
            <button id="modal-cancel" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-text-light dark:text-text-dark rounded hover:bg-gray-400 dark:hover:bg-gray-500 transition">Cancelar</button>
            <button id="modal-confirm" class="px-4 py-2 bg-primary text-white rounded hover:bg-opacity-90 transition">Confirmar</button>
        </div>
    </div>
</div>

</body>
</html>