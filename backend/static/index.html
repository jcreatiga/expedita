<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistema de Consulta Judicial</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>

    <!-- Tailwind (CDN build for quick styling + forms/typography plugins) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#10A37F",
                        "background-light": "#F9FAFB",
                        "background-dark": "#202123",
                        "panel-light": "#FFFFFF",
                        "panel-dark": "#2C2D31",
                        "text-light": "#111827",
                        "text-dark": "#FFFFFF",
                        "secondary-text-light": "#6B7280",
                        "secondary-text-dark": "#A1A1A1",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: '0.5rem',
                    },
                },
            },
        };
    </script>

    <!-- Local (fallback) styles to ensure base dark bg while other CSS loads -->
    <link rel="stylesheet" href="/static/styles.css?v=2">
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        /* Truncate cells with hover-tooltips for long values */
        .truncate-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        .truncate-cell:hover .full-text {
            display: block;
        }
        .full-text {
            display: none;
            position: absolute;
            background-color: #374151;
            color: #F9FAFB;
            padding: 8px;
            border-radius: 6px;
            z-index: 50;
            top: 100%;
            left: 0;
            white-space: normal;
            width: max-content;
            max-width: 520px;
            box-shadow: 0 6px 18px rgba(2,6,23,0.7);
        }

        /* Small helper to visually hide table when empty */
        .table-empty { padding: 28px; color: var(--secondary-text-dark); }

        /* Debug panel for showing backend responses */
        #debug-panel {
            margin-top: 18px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.02);
            color: #cbd5e1;
            font-size: 13px;
            max-height: 220px;
            overflow: auto;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark font-sans transition-colors duration-300">

<!-- LOGIN SCREEN (visible by default) -->
<div class="min-h-screen flex flex-col items-center justify-center p-4" id="login-screen">
    <div class="w-full max-w-md">
        <h1 class="text-3xl font-bold text-center mb-2 text-text-light dark:text-text-dark">Sistema de Consulta Judicial</h1>
        <p class="text-center text-secondary-text-light dark:text-secondary-text-dark mb-8">Bienvenido de nuevo</p>

        <div class="bg-panel-light dark:bg-panel-dark p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-6 text-text-light dark:text-text-dark">Iniciar Sesión</h2>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-2" for="login-email">Email</label>
                    <input id="login-email" name="email" type="email" class="w-full px-4 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary transition duration-200" required />
                </div>

                <div>
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-2" for="login-password">Contraseña</label>
                    <input id="login-password" name="password" type="password" class="w-full px-4 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary transition duration-200" required />
                </div>

                <button type="submit" class="w-full bg-primary text-white font-semibold py-2 px-4 rounded-md hover:bg-opacity-90 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-lg">
                    Iniciar Sesión
                </button>
            </form>

            <p class="text-center text-sm text-secondary-text-light dark:text-secondary-text-dark mt-6">
                ¿No tienes cuenta? <a class="text-primary hover:underline" href="#" onclick="showRegister()">Regístrate</a>
            </p>
        </div>
    </div>
</div>

<!-- APP SCREEN (hidden until login) -->
<div class="hidden min-h-screen" id="app-screen">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-20 lg:w-64 bg-panel-light dark:bg-panel-dark p-4 flex flex-col transition-all duration-300 min-h-screen">
            <div class="flex items-center justify-center lg:justify-start mb-10">
                <span class="material-icons text-primary text-3xl">gavel</span>
                <span class="ml-3 text-xl font-bold text-text-light dark:text-text-dark hidden lg:inline">Consulta</span>
            </div>

            <nav class="flex-grow">
                <ul>
                    <li class="mb-2">
                        <a id="tab-query" class="flex items-center p-3 rounded-lg text-secondary-text-light dark:text-secondary-text-dark hover:bg-background-light dark:hover:bg-background-dark hover:text-primary transition-colors duration-200 cursor-pointer">
                            <span class="material-icons">search</span>
                            <span class="ml-4 font-medium hidden lg:inline">Consultar Procesos</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a id="tab-saved" class="flex items-center p-3 rounded-lg text-secondary-text-light dark:text-secondary-text-dark hover:bg-background-light dark:hover:bg-background-dark hover:text-primary transition-colors duration-200 cursor-pointer">
                            <span class="material-icons">bookmark_border</span>
                            <span class="ml-4 font-medium hidden lg:inline">Procesos Guardados</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a id="tab-logs" class="flex items-center p-3 rounded-lg text-secondary-text-light dark:text-secondary-text-dark hover:bg-background-light dark:hover:bg-background-dark hover:text-primary transition-colors duration-200 cursor-pointer">
                            <span class="material-icons">bug_report</span>
                            <span class="ml-4 font-medium hidden lg:inline">Logs de Debug</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <div class="flex items-center p-2">
                    <div id="avatar" class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold">
                        JR
                    </div>
                    <div class="ml-3 hidden lg:inline">
                        <p id="user-email" class="text-sm font-medium text-text-light dark:text-text-dark">user@example.com</p>
                        <button id="logout-btn" class="text-xs text-secondary-text-light dark:text-secondary-text-dark hover:text-primary mt-1">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="flex-1 p-6 lg:p-10 bg-background-light dark:bg-background-dark min-h-screen">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-text-light dark:text-text-dark">Consulta de Procesos Judiciales</h1>
                <p class="text-lg text-secondary-text-light dark:text-secondary-text-dark mt-2">Ingresa los números de radicación para iniciar la consulta.</p>
            </header>

            <div class="bg-panel-light dark:bg-panel-dark p-8 rounded-lg shadow-md">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark mb-2" for="process-numbers">Ingresa hasta 10 números de radicación separados por comas:</label>
                    <textarea id="batch-numbers" class="w-full p-4 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md focus:ring-primary focus:border-primary transition duration-200" placeholder="Ej: 11001418902420250012, ..." rows="4"></textarea>
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="btn-batch-query" class="w-full sm:w-auto bg-primary text-white font-semibold py-3 px-6 rounded-md hover:bg-opacity-90 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-lg flex items-center justify-center">
                        <span class="material-icons mr-2">search</span>
                        Consultar Procesos
                    </button>

                    <button id="btn-api-test" class="w-full sm:w-auto bg-transparent border border-primary text-primary font-semibold py-3 px-6 rounded-md hover:bg-primary hover:text-white transition-colors duration-200 flex items-center justify-center">
                        <span class="material-icons mr-2">api</span>
                        Probar Conexión API
                    </button>
                </div>

                <!-- Progress indicator -->
                <div id="query-progress" class="mt-4 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <div id="progress-text" class="text-sm text-secondary-text-light dark:text-secondary-text-dark">0 de 0 procesos consultados</div>
                        <div id="progress-status" class="text-sm text-secondary-text-light dark:text-secondary-text-dark"></div>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div id="progress-bar" class="h-2 rounded-full bg-primary" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="mt-12">
                <h2 class="text-2xl font-semibold mb-6 text-text-light dark:text-text-dark">Resultados</h2>
                <div id="query-result" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </main>
    </div>
</div>

<!-- Scripts: reuse existing logic but adapt to new IDs and screen toggles -->
<script>
    // Keep auth token and current user
    let authToken = localStorage.getItem('authToken');
    let currentUser = null;

    const loginScreen = document.getElementById('login-screen');
    const appScreen = document.getElementById('app-screen');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const userEmailSpan = document.getElementById('user-email');

    // Buttons
    const btnBatchQuery = document.getElementById('btn-batch-query');
    const btnApiTest = document.getElementById('btn-api-test');

    // Tabs
    document.getElementById('tab-query').addEventListener('click', () => showTab('query'));
    document.getElementById('tab-saved').addEventListener('click', () => showTab('saved'));
    document.getElementById('tab-logs').addEventListener('click', () => showTab('logs'));

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        if (authToken) {
            // verify token quickly (non-blocking)
            showApp();
            loadUserInfo();
        } else {
            showAuth();
        }
    });

    // Login form submit
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await login();
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
        logout();
    });

    // Wire main action buttons
    btnBatchQuery.addEventListener('click', () => batchQuery());
    btnApiTest.addEventListener('click', () => testAPIConnection());

    // Show/hide helpers
    function showAuth() {
        loginScreen.classList.remove('hidden');
        appScreen.classList.add('hidden');
    }

    function showApp() {
        loginScreen.classList.add('hidden');
        appScreen.classList.remove('hidden');
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if (!email || !password) {
            alert('Por favor completa todos los campos');
            return;
        }

        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (response.ok) {
                authToken = data.access_token;
                localStorage.setItem('authToken', authToken);
                showApp();
                await loadUserInfo();
            } else {
                alert(data.detail || 'Error en el inicio de sesión');
            }
        } catch (error) {
            alert('Error de conexión');
        }
    }

    async function register() {
        // simple register flow to mirror previous behavior
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if (!email || !password) {
            alert('Por favor completa todos los campos');
            return;
        }

        try {
            const response = await fetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await response.json();
            if (response.ok) {
                authToken = data.access_token;
                localStorage.setItem('authToken', authToken);
                showApp();
                await loadUserInfo();
            } else {
                alert(data.detail || 'Error en el registro');
            }
        } catch (err) {
            alert('Error de conexión');
        }
    }

    function showRegister(){
        // open register: reuse login inputs but call register instead
        if (confirm('Registrar con los datos ingresados en el formulario?')) {
            register();
        }
    }

    function logout() {
        authToken = null;
        localStorage.removeItem('authToken');
        currentUser = null;
        userEmailSpan.textContent = '';
        showAuth();
    }

    async function loadUserInfo() {
        if (!authToken) return;
        try {
            const response = await fetch('/auth/me', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            if (response.ok) {
                currentUser = await response.json();
                userEmailSpan.textContent = ` ${currentUser.email}`;
                // set avatar initials
                const initials = (currentUser.email || 'U').split('@')[0].slice(0,2).toUpperCase();
                document.getElementById('avatar').textContent = initials;
            } else {
                logout();
            }
        } catch (error) {
            console.error('Error loading user info:', error);
        }
    }

    // Tabs handling
    function showTab(tabName){
        // simple client-only switching for demo; could trigger loads
        document.querySelectorAll('#app-screen nav ul li a').forEach(a => a.classList.remove('bg-background-light','dark:bg-background-dark'));
        if(tabName === 'query'){
            // ensure query is visible (we only have one main view so nothing to toggle)
        } else if(tabName === 'saved'){
            loadSavedProcesses();
        } else if(tabName === 'logs'){
            loadLogs();
        }
    }

    // Batch query (now calls single-query per radicado to enable progress updates)
    async function batchQuery() {
        const raw = document.getElementById('batch-numbers').value.trim();
        if (!raw) {
            alert('Por favor ingresa al menos un número de radicación');
            return;
        }
        const numbers = raw.split(',').map(n => n.trim()).filter(n => n);
        if (numbers.length > 10) {
            alert('Máximo 10 procesos por consulta');
            return;
        }

        // Validate and normalize
        const validNumbers = [];
        for (const num of numbers) {
            if (num.length !== 23 || !/^\d+$/.test(num)) {
                console.warn(`Formato inesperado para: ${num}`);
                validNumbers.push(num); // include but will likely error server-side
            } else {
                validNumbers.push(num);
            }
        }

        if (validNumbers.length === 0) {
            alert('No hay números válidos para consultar.');
            return;
        }

        // Show progress UI
        const progressContainer = document.getElementById('query-progress');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const progressStatus = document.getElementById('progress-status');
        progressContainer.classList.remove('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = `0 de ${validNumbers.length} procesos consultados`;
        progressStatus.textContent = 'Iniciando consultas...';

        // Ensure debug panel is visible and cleared
        const debugPanel = document.getElementById('debug-panel');
        if (debugPanel) {
            debugPanel.classList.remove('hidden');
            debugPanel.innerHTML = '<h3 class="text-sm font-medium mb-2 text-secondary-text-light dark:text-secondary-text-dark">Debug responses (most recent arriba)</h3>';
        }

        lastResults = [];
        // Process sequentially to avoid blocking the judicial API
        for (let i = 0; i < validNumbers.length; i++) {
            const numero = validNumbers[i];
            progressStatus.textContent = `Consultando ${i + 1} de ${validNumbers.length}: ${numero}`;
            try {
                const resp = await fetch(`/processes/single-query/${encodeURIComponent(numero)}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await resp.json();

                // Append raw response to debug panel
                if (debugPanel) {
                    const entry = document.createElement('div');
                    entry.style.whiteSpace = 'pre-wrap';
                    entry.style.fontSize = '12px';
                    entry.style.padding = '8px';
                    entry.style.marginBottom = '8px';
                    entry.style.background = 'rgba(255,255,255,0.02)';
                    entry.style.borderRadius = '6px';
                    entry.style.color = '#cbd5e1';
                    entry.innerText = `[${new Date().toLocaleTimeString()}] ${numero} -> ${JSON.stringify(data, null, 2)}`;
                    debugPanel.insertBefore(entry, debugPanel.children[1] || null);
                }

                if (resp.ok && data.status === 'success' && data.result) {
                    // push the processed result
                    lastResults.push(data.result);
                } else {
                    // If the backend returned an error, create a placeholder row so user sees it
                    const errDetail = (data && (data.detail || data.raw || data.error)) || 'Error desconocido';
                    lastResults.push({
                        numero: numero,
                        fecha_ultima_actuacion: null,
                        despacho: 'N/A',
                        departamento: 'N/A',
                        demandante: 'N/A',
                        demandado: 'N/A',
                        id_proceso: null,
                        is_today: false,
                        tipo_proceso: '',
                        clase_proceso: '',
                        subclase_proceso: '',
                        recurso: '',
                        ponente: '',
                        ubicacion: '',
                        error: String(errDetail)
                    });
                    console.warn(`Consulta fallida para ${numero}:`, errDetail);
                }

                // Re-render after each item so the table appears progressively
                renderResultsTable(lastResults);

            } catch (err) {
                console.error(`Error consultando ${numero}:`, err);
                // append error to debug panel
                if (debugPanel) {
                    const entry = document.createElement('div');
                    entry.style.whiteSpace = 'pre-wrap';
                    entry.style.fontSize = '12px';
                    entry.style.padding = '8px';
                    entry.style.marginBottom = '8px';
                    entry.style.background = 'rgba(255,0,0,0.03)';
                    entry.style.borderRadius = '6px';
                    entry.style.color = '#f8d7da';
                    entry.innerText = `[${new Date().toLocaleTimeString()}] ${numero} -> EXCEPTION: ${String(err)}`;
                    debugPanel.insertBefore(entry, debugPanel.children[1] || null);
                }

                lastResults.push({
                    numero: numero,
                    fecha_ultima_actuacion: null,
                    despacho: 'N/A',
                    departamento: 'N/A',
                    demandante: 'N/A',
                    demandado: 'N/A',
                    id_proceso: null,
                    is_today: false,
                    tipo_proceso: '',
                    clase_proceso: '',
                    subclase_proceso: '',
                    recurso: '',
                    ponente: '',
                    ubicacion: '',
                    error: String(err)
                });
                renderResultsTable(lastResults);
            }

            // update progress
            const completed = i + 1;
            const pct = Math.round((completed / validNumbers.length) * 100);
            progressBar.style.width = `${pct}%`;
            progressText.textContent = `${completed} de ${validNumbers.length} procesos consultados`;

            // delay between requests to be polite to API (and mimic previous behavior)
            if (i < validNumbers.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
        }

        progressStatus.textContent = 'Completado';
        // hide progress after short delay
        setTimeout(() => {
            progressContainer.classList.add('hidden');
        }, 1200);
    }

    // Store last results for sorting / re-render
    let lastResults = [];
    let allResults = [];
    let filteredResults = [];
    let currentPage = 1;
    let pageSize = 25;

    function renderResultsTable(results) {
        const container = document.getElementById('query-result');
        if (!results || results.length === 0) {
            container.innerHTML = '<div class="table-empty">No hay resultados.</div>';
            return;
        }

        // Controls for filter and pagination
        const controlsHtml = `
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                <div class="flex items-center gap-4">
                    <label for="table-filter" class="text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark">Filtrar:</label>
                    <input id="table-filter" type="text" placeholder="Buscar en resultados..." class="px-3 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-primary focus:border-primary" oninput="filterTable()">
                </div>
                <div class="flex items-center gap-4">
                    <label for="table-page-size" class="text-sm font-medium text-secondary-text-light dark:text-secondary-text-dark">Mostrar:</label>
                    <select id="table-page-size" class="px-3 py-2 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-primary focus:border-primary" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
        `;

        // Table with improved container and accessibility
        const tableHtml = `
            <div class="table-container">
                <table id="results-table" role="table" aria-label="Resultados de consulta de procesos judiciales">
                    <thead>
                        <tr>
                            <th scope="col" onclick="sortTable('numero')" style="cursor:pointer;" aria-sort="none">Radicado</th>
                            <th scope="col" onclick="sortTable('demandante')" style="cursor:pointer;" aria-sort="none">Demandante</th>
                            <th scope="col" onclick="sortTable('demandado')" style="cursor:pointer;" aria-sort="none">Demandado</th>
                            <th scope="col" onclick="sortTable('despacho')" style="cursor:pointer;" aria-sort="none">Juzgado</th>
                            <th scope="col" onclick="sortTable('clase_proceso')" style="cursor:pointer;" aria-sort="none">Clase</th>
                            <th scope="col" onclick="sortTable('ubicacion')" style="cursor:pointer;" aria-sort="none">Ubicación</th>
                            <th scope="col" onclick="sortTable('fecha_ultima_actuacion')" style="cursor:pointer;" aria-sort="none">Fecha Última Actuación</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = controlsHtml + tableHtml;

        // Initialize pagination and filtering
        allResults = [...results];
        filteredResults = [...results];
        currentPage = 1;
        pageSize = parseInt(document.getElementById('table-page-size').value) || 25;
        renderTablePage();
    }

    // Filter table based on input
    function filterTable() {
        const filterValue = document.getElementById('table-filter').value.toLowerCase();
        filteredResults = allResults.filter(proc =>
            (proc.numero || '').toLowerCase().includes(filterValue) ||
            (proc.demandante || '').toLowerCase().includes(filterValue) ||
            (proc.demandado || '').toLowerCase().includes(filterValue) ||
            (proc.despacho || '').toLowerCase().includes(filterValue) ||
            (proc.clase_proceso || '').toLowerCase().includes(filterValue) ||
            (proc.ubicacion || '').toLowerCase().includes(filterValue)
        );
        currentPage = 1;
        renderTablePage();
    }

    // Change page size
    function changePageSize() {
        pageSize = parseInt(document.getElementById('table-page-size').value);
        currentPage = 1;
        renderTablePage();
    }

    // Render current page of results
    function renderTablePage() {
        const tbody = document.getElementById('results-tbody');
        tbody.innerHTML = '';

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageResults = filteredResults.slice(startIndex, endIndex);

        pageResults.forEach(proc => {
            const fecha = proc.fecha_ultima_actuacion ? (new Date(proc.fecha_ultima_actuacion)).toLocaleDateString('es-CO') : 'N/A';
            const demandante = proc.demandante || 'N/A';
            const demandado = proc.demandado || 'N/A';
            const despacho = proc.despacho || 'Información no disponible.';
            const clase = proc.clase_proceso || proc.claseProceso || 'N/A';
            const ubic = proc.ubicacion || proc.ubicacion || 'N/A';

            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700 hover:bg-background-light dark:hover:bg-background-dark transition-colors duration-200';

            // Safely build the row HTML and pass the proc JSON as an encoded string argument
            const encodedProc = encodeURIComponent(JSON.stringify(proc));
            row.innerHTML = `
                <th class="px-6 py-4 font-medium text-text-light dark:text-text-dark whitespace-nowrap" scope="row">${proc.numero}</th>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(demandante)}</span><span class="full-text">${escapeHtml(demandante)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(demandado)}</span><span class="full-text">${escapeHtml(demandado)}</span></td>
                <td class="px-6 py-4 truncate-cell"><span>${escapeHtml(despacho)}</span><span class="full-text">${escapeHtml(despacho)}</span></td>
                <td class="px-6 py-4 truncate-cell">${escapeHtml(clase)}</td>
                <td class="px-6 py-4 truncate-cell">${escapeHtml(ubic)}</td>
                <td class="px-6 py-4">${escapeHtml(fecha)}</td>
                <td class="px-6 py-4 text-right">
                    <button class="font-medium text-primary hover:underline flex items-center gap-1" onclick="saveProcess('${proc.numero}', '${encodedProc}')">
                        <span class="material-icons text-sm">bookmark_add</span>
                        Guardar
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Add pagination controls if needed
        const totalPages = Math.ceil(filteredResults.length / pageSize);
        if (totalPages > 1) {
            const paginationHtml = `
                <div class="flex justify-center items-center gap-2 mt-4">
                    <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="px-3 py-1 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded text-sm">Anterior</button>
                    <span class="text-sm text-secondary-text-light dark:text-secondary-text-dark">Página ${currentPage} de ${totalPages}</span>
                    <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} class="px-3 py-1 bg-background-light dark:bg-background-dark border border-gray-300 dark:border-gray-600 rounded text-sm">Siguiente</button>
                </div>
            `;
            const existingPagination = document.getElementById('pagination-controls');
            if (existingPagination) {
                existingPagination.innerHTML = paginationHtml;
            } else {
                const paginationDiv = document.createElement('div');
                paginationDiv.id = 'pagination-controls';
                paginationDiv.innerHTML = paginationHtml;
                tbody.parentElement.parentElement.appendChild(paginationDiv);
            }
        } else {
            const existingPagination = document.getElementById('pagination-controls');
            if (existingPagination) existingPagination.innerHTML = '';
        }
    }

    // Change page
    function changePage(page) {
        const totalPages = Math.ceil(filteredResults.length / pageSize);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderTablePage();
        }
    }

    function displayBatchResults(results){
        // Normalize results (ensure keys for clase_proceso/ubicacion exist)
        lastResults = results.map(r => {
            return {
                ...r,
                clase_proceso: r.clase_proceso || r.claseProceso || '',
                ubicacion: r.ubicacion || r.ubicacion || '',
                fecha_ultima_actuacion: r.fecha_ultima_actuacion || r.fechaUltimaActuacion || r.fechaUltimaActuacionISO || null
            };
        });
        renderResultsTable(lastResults);
    }

    // Simple sort implementation (toggles asc/desc)
    let currentSort = { col: null, dir: 1 }; // 1 asc, -1 desc
    function sortTable(col){
        if (!col) return;
        if (currentSort.col === col) currentSort.dir = -currentSort.dir;
        else { currentSort.col = col; currentSort.dir = 1; }

        lastResults.sort((a,b) => {
            const va = (a[col] || '').toString().toLowerCase();
            const vb = (b[col] || '').toString().toLowerCase();
            if (va < vb) return -1 * currentSort.dir;
            if (va > vb) return 1 * currentSort.dir;
            return 0;
        });
        renderResultsTable(lastResults);
    }

    // Helper to POST saved process to backend
    async function saveProcess(numero, procString) {
        try {
            const proc = JSON.parse(decodeURIComponent(procString));
            const payload = {
                numero: proc.numero || numero,
                id_proceso: proc.id_proceso || proc.idProceso || proc.id_proceso || '',
                fecha_ultima_actuacion: proc.fecha_ultima_actuacion || proc.fechaUltimaActuacion || null,
                despacho: proc.despacho || '',
                departamento: proc.departamento || '',
                demandante: proc.demandante || '',
                demandado: proc.demandado || '',
                response_json: proc.response_json || proc.responseJson || null,
                detalle_json: proc.detalle_json || proc.detalleJson || null,
                tipo_proceso: proc.tipo_proceso || '',
                clase_proceso: proc.clase_proceso || '',
                subclase_proceso: proc.subclase_proceso || '',
                recurso: proc.recurso || '',
                ponente: proc.ponente || '',
                ubicacion: proc.ubicacion || ''
            };

            const resp = await fetch('/processes/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(payload)
            });

            const data = await resp.json();
            if (resp.ok) {
                alert(`Proceso ${numero} guardado (${data.action})`);
            } else {
                alert(`Error guardando proceso: ${data.detail || JSON.stringify(data)}`);
            }
        } catch (err) {
            console.error('saveProcess error:', err);
            alert('Error guardando proceso (ver consola).');
        }
    }

    // Utility to escape HTML in table cells
    function escapeHtml(text){
        if (text === null || text === undefined) return '';
        return String(text)
            .replace(/&/g, '&')
            .replace(/</g, '<')
            .replace(/>/g, '>')
            .replace(/"/g, '"')
            .replace(/'/g, '&#039;');
    }

    async function testAPIConnection(){
        try{
            const response = await fetch('/api-test');
            const data = await response.json();
            if(response.ok && data.status === 'success'){
                alert('Conexión API exitosa');
            } else {
                alert('Error al conectar con la API');
            }
        } catch(err){
            alert('Error de conexión');
        }
    }

    // Saved processes and logs (light implementations)
    async function loadSavedProcesses(){
        if(!authToken) return;
        try{
            const resp = await fetch('/processes/my-processes', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const data = await resp.json();
            if(resp.ok){
                // reuse display logic
                displayBatchResults(data.processes || []);
            } else {
                alert(data.detail || 'Error cargando procesos guardados');
            }
        } catch(err){
            console.error(err);
            alert('Error de conexión');
        }
    }

    async function loadLogs(){
        if(!authToken) return;
        try{
            const resp = await fetch('/logs', { headers: { 'Authorization': `Bearer ${authToken}` }});
            const data = await resp.json();
            if(resp.ok){
                // show logs in query-result for now
                const container = document.getElementById('query-result');
                container.innerHTML = '<pre class="text-sm text-secondary-text-light dark:text-secondary-text-dark">' + JSON.stringify(data.logs || [], null, 2) + '</pre>';
            } else {
                alert('Error cargando logs');
            }
        } catch(e){
            console.error(e);
            alert('Error de conexión');
        }
    }
</script>

</body>
</html>